%  template.tex for Biometrics papers
%
%  This file provides a template for Biometrics authors.  Use this
%  template as the starting point for creating your manuscript document.
%  See the file biomsample.tex for an example of a full-blown manuscript.

%  ALWAYS USE THE referee OPTION WITH PAPERS SUBMITTED TO BIOMETRICS!!!
%  You can see what your paper would look like typeset by removing
%  the referee option.  Because the typeset version will be in two
%  columns, however, some of your equations may be too long. DO NOT
%  use the \longequation option discussed in the user guide!!!  This option
%  is reserved ONLY for equations that are impossible to split across 
%  multiple lines; e.g., a very wide matrix.  Instead, type your equations 
%  so that they stay in one column and are split across several lines, 
%  as are almost all equations in the journal.  Use a recent version of the
%  journal as a guide. 
%  
\documentclass[useAMS,referee]{biom}

\usepackage{graphicx}
\graphicspath{{pics/}}
\usepackage{setspace}
\usepackage{titlesec}

\usepackage{booktabs}
\setlength{\parskip}{0pt}

%documentclass[useAMS]{biom}
%
%  If your system does not have the AMS fonts version 2.0 installed, then
%  remove the useAMS option.
%
%  useAMS allows you to obtain upright Greek characters.
%  e.g. \umu, \upi etc.  For further information, see the section on "Upright Greek characters" in
%  this guide.
%
%  If you are using AMS 2.0 fonts, bold math letters/symbols are available
%  at a more extensive range of sizes for NFSS release 1 and 2 (using \boldmath or
%  preferably \bmath).
% 
%  Other options are described in the user guide. Here are a few:
% 
%  -  If you use Patrick Daly's natbib  to cross-reference your 
%     bibliography entries, use the usenatbib option
%
%  -  If you use \includegraphics (graphicx package) for importing graphics
%     into your figures, use the usegraphicx option
% 
%  If you wish to typeset the paper in Times font (if you do not have the
%  PostScript Type 1 Computer Modern fonts you will need to do this to get
%  smoother fonts in a PDF file) then uncomment the next line
%  \usepackage{Times}

%%%%% PLACE YOUR OWN MACROS HERE %%%%%
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{xcolor}
%\usepackage{natbib}


\usepackage{algorithm}
\usepackage{subfigure}

\usepackage{algpseudocode}
\usepackage{biblatex}

\addbibresource{biomsample.bib}
\renewcommand*{\nameyeardelim}{\addcomma\space}
\renewbibmacro*{in:}{%
  \iffieldundef{journaltitle}
    {}
    {\printtext{\intitlepunct}}}

\def\bSig\mathbf{\Sigma}
\newcommand{\VS}{V\&S}
\newcommand{\tr}{\mbox{tr}}
\usepackage{tikz}

\newcommand*{\tikzbulletred}{%
  \setbox0=\hbox{\strut}%
  \begin{tikzpicture}
  \fill[red] (0,0) circle (0.1cm);
\end{tikzpicture}%
}


\newcommand*{\tikzbulletgreen}{%
  \setbox0=\hbox{\strut}%
  \begin{tikzpicture}
  \fill[green] (0,0) circle (0.1cm);
\end{tikzpicture}%
}



\newcommand*{\tikzbulletyellow}{%
  \setbox0=\hbox{\strut}%
  \begin{tikzpicture}
  \fill[yellow] (0,0) circle (0.1cm);
\end{tikzpicture}%
}



\newcommand*{\tikzbulletblue}{%
  \setbox0=\hbox{\strut}%
  \begin{tikzpicture}
  \fill[blue] (0,0) circle (0.1cm);
\end{tikzpicture}%
}

\titlespacing*{\section}{0pt}{3pt}{0pt}

\titlespacing*{\subsection}{0pt}{1.5pt}{0pt}
%  The rotating package allows you to have tables displayed in landscape
%  mode.  The rotating package is NOT included in this distribution, but
%  can be obtained from the CTAN archive.  USE OF LANDSCAPE TABLES IS
%  STRONGLY DISCOURAGED -- create landscape tables only as a last resort if
%  you see no other way to display the information.  If you do do this,
%  then you need the following command.

%\usepackage[figuresright]{rotating}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%  Here, place your title and author information.  Note that in 
%  use of the \author command, you create your own footnotes.  Follow
%  the examples below in creating your author and affiliation information.
%  Also consult a recent issue of the journal for examples of formatting.

\title{
Algorithm and Derivations}


%  Here are examples of different configurations of author/affiliation
%  displays.  According to the Biometrics style, in some instances,
%  the convention is to have superscript *, **, etc footnotes to indicate 
%  which of multiple email addresses belong to which author.  In this case,
%  use the \email{ } command to produce the emails in the display.

%  In other cases, such as a single author or two authors from 
%  different institutions, there should be no footnoting.  Here, use
%  the \emailx{ } command instead. 

%  The examples below corrspond to almost every possible configuration
%  of authors and may be used as a guide.  For other configurations, consult
%  a recent issue of the the journal.

%  Single author -- USE \emailx{ } here so that no asterisk footnoting
%  for the email address will be produced.

%\author{John Author\emailx{email@address.edu} \\
%Department of Statistics, University of Warwick, Coventry CV4 7AL, U.K.}

%  Two authors from the same institution, with both emails -- use
%  \email{ } here to produce the asterisk footnoting for each email address

%\author{John Author$^{*}$\email{author@address.edu} and
%Kathy Authoress$^{**}$\email{email2@address.edu} \\
%Department of Statistics, University of Warwick, Coventry CV4 7AL, U.K.}

%  Exactly two authors from different institutions, with both emails  
%  USE \emailx{ } here so that no asterisk footnoting for the email address
%  is produced.



%  Three or more authors from same institution with all emails displayed
%  and footnoted using asterisks -- use \email{ } 

%\author{John Author$^*$\email{author@address.edu}, 
%Jane Author$^{**}$\email{jane@address.edu}, and 
%Dick Author$^{***}$\email{dick@address.edu} \\
%Department of Statistics, University of Warwick, Coventry CV4 7AL, U.K}

%  Three or more authors from same institution with one corresponding email
%  displayed

%\author{John Author$^*$\email{author@address.edu}, 
%Jane Author, and Dick Author \\
%Department of Statistics, University of Warwick, Coventry CV4 7AL, U.K}

%  Three or more authors, with at least two different institutions,
%  more than one email displayed 

%\author{John Author$^{1,*}$\email{author@address.edu}, 
%Kathy Author$^{2,**}$\email{anotherauthor@address.edu}, and 
%Wilma Flinstone$^{3,***}$\email{wilma@bedrock.edu} \\
%$^{1}$Department of Statistics, University of Warwick, Coventry CV4 7AL, U.K \\
%$^{2}$Department of Biostatistics, University of North Carolina at 
%Chapel Hill, Chapel Hill, North Carolina, U.S.A. \\
%$^{3}$Department of Geology, University of Bedrock, Bedrock, Kansas, U.S.A.}

%  Three or more authors with at least two different institutions and only
%  one email displayed

%\author{John Author$^{1,*}$\email{author@address.edu}, 
%Wilma Flinstone$^{2}$, and Barney Rubble$^{2}$ \\
%$^{1}$Department of Statistics, University of Warwick, Coventry CV4 7AL, U.K \\
%$^{2}$Department of Geology, University of Bedrock, Bedrock, Kansas, U.S.A.}


\begin{document}

%  This will produce the submission and review information that appears
%  right after the reference section.  Of course, it will be unknown when
%  you submit your paper, so you can either leave this out or put in 
%  sample dates (these will have no effect on the fate of your paper in the
%  review process!)

\date{{\it Received October} 2007. {\it Revised February} 2008.  {\it
Accepted March} 2008.}

%  These options will count the number of pages and provide volume
%  and date information in the upper left hand corner of the top of the 
%  first page as in published papers.  The \pagerange command will only
%  work if you place the command \label{firstpage} near the beginning
%  of the document and \label{lastpage} at the end of the document, as we
%  have done in this template.

%  Again, putting a volume number and date is for your own amusement and
%  has no bearing on what actually happens to your paper!  



%  The \doi command is where the DOI for your paper would be placed should it
%  be published.  Again, if you make one up and stick it here, it means 
%  nothing!

\doi{10.1111/j.1541-0420.2005.00454.x}

%  This label and the label ``lastpage'' are used by the \pagerange
%  command above to give the page range for the article.  You may have 
%  to process the document twice to get this to match up with what you 
%  expect.  When using the referee option, this will not count the pages
%  with tables and figures.  

\label{firstpage}

%  put the summary for your paper here



%  Please place your key words in alphabetical order, separated
%  by semicolons, with the first letter of the first word capitalized,
%  and a period at the end of the list.
%

\begin{keywords}
A key word; But another key word; Still another key word; Yet another key word.
\end{keywords}

%  As usual, the \maketitle command creates the title and author/affiliations
%  display 

\maketitle

%  If you are using the referee option, a new page, numbered page 1, will
%  start after the summary and keywords.  The page numbers thus count the
%  number of pages of your manuscript in the preferred submission style.
%  Remember, ``Normally, regular papers exceeding 25 pages and Reader Reaction 
%  papers exceeding 12 pages in (the preferred style) will be returned to 
%  the authors without review. The page limit includes acknowledgements, 
%  references, and appendices, but not tables and figures. The page count does 
%  not include the title page and abstract. A maximum of six (6) tables or 
%  figures combined is often required.''

%  You may now place the substance of your manuscript here.  Please use
%  the \section, \subsection, etc commands as described in the user guide.
%  Please use \label and \ref commands to cross-reference sections, equations,
%  tables, figures, etc.
%
%  Please DO NOT attempt to reformat the style of equation numbering!
%  For that matter, please do not attempt to redefine anything!

\section*{1. Model Specification}

We assume that the survival times $T_{ij}$ satisfy the accelerated failure time (AFT) model
\[
\log T_{ij} = f(X_{ij}) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij} \sim N(0,\sigma^2), \quad i=1,\ldots,I,\; j=1,\ldots,n_i,
\]
where:
\begin{itemize}
  \item $f(\cdot)$ is a flexible (nonparametric) function modeled via SoftBART.
  \item $r_i$ is the spatial random effect for area $i$. 
  \item The spatial effects follow a Conditional Autoregressive (CAR) prior:
    \[
    p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho) \vert^{1/2} \exp\left\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\right\},
    \]
    where $\bm{r}=(r_1,\ldots,r_I)^\top$, and
    \[
    Q(\rho) = D - \rho\, W,
    \]
    with $W$ being the spatial adjacency matrix and $D$ the diagonal matrix with $D_{ii}=\sum_j W_{ij}$.
  \item Right censoring is present. We observe
    \[
    T_{ij}^{\text{obs}} = \min(T_{ij},C_{ij})\quad \text{with indicator } \delta_{ij}=I(T_{ij}\le C_{ij}).
    \]
    We work on the log-scale with $y_{ij} = \log T_{ij}^{\text{obs}}$ and introduce latent variables $y_{ij}^\ast$ to handle censoring.
\end{itemize}

\section*{2. Algorithm}

The MCMC algorithm proceeds as follows:

\begin{enumerate}
  \item \textbf{Initialization:}
    \begin{enumerate}
      \item For each observation $(i,j)$, set 
        \[
        y_{ij} = \log T_{ij}^{\text{obs}}.
        \]
      \item For uncensored observations ($\delta_{ij}=1$) set $y_{ij}^\ast=y_{ij}$; for censored observations ($\delta_{ij}=0$) initialize $y_{ij}^\ast=y_{ij}$ (as a lower bound).
      \item Initialize the SoftBART model for $f(\cdot)$ (using the current $y_{ij}$ or $y_{ij}^\ast$), set $r_i=0$, and choose initial values for $\sigma^2$, $\sigma_r^2$, and $\rho$.
    \end{enumerate}
  
  \item \textbf{MCMC Iterations:} For each iteration $t=1,\ldots,n_{\text{iter}}$, do:
    \begin{enumerate}
      \item \textbf{Data Augmentation for Right Censoring:} For each censored observation $(i,j)$ (i.e. $\delta_{ij}=0$), sample
        \[
        y_{ij}^\ast \sim N\Big(f(X_{ij})+r_i,\ \sigma^2\Big)
        \]
        truncated to the interval $[y_{ij}, \infty)$. For uncensored observations, set $y_{ij}^\ast=y_{ij}$.
      
      \item \textbf{Update $f(\cdot)$ via SoftBART:}  
        With the current spatial effects $\{r_i\}$, define the working response
        \[
        z_{ij} = y_{ij}^\ast - r_i.
        \]
        Use the SoftBART update (a Gibbs step) with data $\{(X_{ij},z_{ij})\}$ to obtain updated predictions for $f(X_{ij})$.
      
      \item \textbf{Update the Spatial Random Effects $\bm{r}$:}  
        For each group $i$, the likelihood contribution is
        \[
        \prod_{j\in \mathcal{I}_i} \exp\Big\{-\frac{1}{2\sigma^2}\big[y_{ij}^\ast-f(X_{ij})-r_i\big]^2\Big\}.
        \]
        Define for each group $i$:
        \[
        \mu_i^\ast = \frac{1}{n_i}\sum_{j\in \mathcal{I}_i}\Big[y_{ij}^\ast-f(X_{ij})\Big],\quad b_i = \frac{1}{\sigma^2}\sum_{j\in \mathcal{I}_i}\Big[y_{ij}^\ast-f(X_{ij})\Big],
        \]
        where $n_i$ is the number of observations in group $i$.  
        
        Let $N=\operatorname{diag}(n_1,\ldots,n_I)$. Then the full conditional for $\bm{r}$ is
        \[
        \bm{r}\mid \cdot \sim \mathcal{N}\Bigl(\Lambda^{-1}\bm{b},\, \Lambda^{-1}\Bigr),\quad \text{with } \Lambda = \frac{N}{\sigma^2} + \frac{Q(\rho)}{\sigma_r^2}.
        \]
        
        \textbf{Derivation:}  
        The log-likelihood (up to constants) is
        \[
        -\frac{1}{2\sigma^2}\sum_{i=1}^I\sum_{j\in \mathcal{I}_i}\Big[y_{ij}^\ast-f(X_{ij})-r_i\Big]^2 
        = -\frac{1}{2\sigma^2}\sum_{i=1}^I n_i \Big(r_i-\mu_i^\ast\Big)^2.
        \]
        The CAR prior gives
        \[
        -\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho) \bm{r}.
        \]
        Adding these yields a quadratic form in $\bm{r}$, which when completed squares results in the stated multivariate normal conditional.
      
      \item \textbf{Update $\sigma^2$ (Residual Variance):}  
        Let the residuals be
        \[
        \varepsilon_{ij} = y_{ij}^\ast - f(X_{ij}) - r_i.
        \]
        If we assign an inverse-gamma prior 
        \[
        \sigma^2 \sim \text{IG}(a_\sigma,b_\sigma),
        \]
        then the full conditional is
        \[
        \sigma^2 \mid \cdot \sim \text{IG}\!\Biggl(a_\sigma+\frac{N}{2},\ b_\sigma+\frac{1}{2}\sum_{i=1}^I\sum_{j\in \mathcal{I}_i} \varepsilon_{ij}^2\Biggr),
        \]
        where $N=\sum_{i=1}^I n_i$ is the total number of observations.
      
      \item \textbf{Update $\sigma_r^2$ (CAR Variance):}  
        With the prior
        \[
        \sigma_r^2 \sim \text{IG}(a_r,b_r),
        \]
        and from the CAR prior term we have
        \[
        \sigma_r^2 \mid \cdot \sim \text{IG}\!\Biggl(a_r+\frac{I}{2},\ b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
        \]
      
      \item \textbf{Update $\rho$ via a Metropolis-Hastings Step:}  
        Propose a candidate $\rho^\ast = \rho + \epsilon$, where $\epsilon \sim N(0,\sigma_{\rho}^2)$, and restrict $\rho^\ast$ to the allowable range (e.g., $(0,1)$).  
        
        The CAR prior density (up to a constant) for $\bm{r}$ is
        \[
        p(\bm{r}\mid \rho,\sigma_r^2) \propto \vert Q(\rho)\vert^{1/2} \exp\!\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\}.
        \]
        Therefore, the acceptance probability is
        \[
        \alpha = \min\left\{1,\ \frac{\vert Q(\rho^\ast)\vert^{1/2}\exp\!\left(-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho^\ast)\bm{r}\right)}
        {\vert Q(\rho)\vert^{1/2}\exp\!\left(-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\right)}\right\}.
        \]
        Accept $\rho^\ast$ with probability $\alpha$, otherwise retain the current value.
    \end{enumerate}
    
  \item \textbf{Post-Processing:}  
    After discarding burn-in and applying thinning, use the posterior samples to:
    \begin{itemize}
      \item Obtain point estimates and credible intervals for $f(\cdot)$.
      \item Estimate the spatial random effects $\bm{r}$.
      \item Estimate the variance parameters $\sigma^2$, $\sigma_r^2$, and the spatial parameter $\rho$.
      \item Compute posterior predictive quantities such as median survival times, survival probabilities, and restricted mean survival times (RMST).
    \end{itemize}
\end{enumerate}

\section*{3. Summary of Full Conditional Derivations}

\subsection*{3.1. Full Conditional for $\bm{r}$}

\textbf{Likelihood:}  
For group $i$, we have
\[
\prod_{j\in \mathcal{I}_i} \exp\!\left\{-\frac{1}{2\sigma^2}\Big[y_{ij}^\ast - f(X_{ij}) - r_i\Big]^2\right\} \propto \exp\!\left\{-\frac{n_i}{2\sigma^2}(r_i-\mu_i^\ast)^2\right\}.
\]
Thus, for all groups,
\[
L(\bm{r}) \propto \exp\!\left\{-\frac{1}{2\sigma^2}\sum_{i=1}^I n_i(r_i-\mu_i^\ast)^2\right\}.
\]

\textbf{Prior (CAR):}  
\[
p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho)\vert^{1/2}\exp\!\left\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\right\}.
\]

\textbf{Posterior:}  
Combining the likelihood and prior, the joint (unnormalized) density is
\[
p(\bm{r}\mid \cdot) \propto \exp\!\left\{-\frac{1}{2}\left[\bm{r}^\top \left(\frac{N}{\sigma^2} + \frac{Q(\rho)}{\sigma_r^2}\right)\bm{r} - 2\bm{b}^\top\bm{r}\right]\right\},
\]
where $\bm{b}$ is defined componentwise as
\[
b_i = \frac{1}{\sigma^2}\sum_{j\in \mathcal{I}_i}\Big[y_{ij}^\ast-f(X_{ij})\Big].
\]
Completing the square gives
\[
\bm{r}\mid\cdot \sim \mathcal{N}\Bigl(\Lambda^{-1}\bm{b},\, \Lambda^{-1}\Bigr),\quad \text{with } \Lambda = \frac{N}{\sigma^2} + \frac{Q(\rho)}{\sigma_r^2}.
\]

\subsection*{3.2. Full Conditional for $\sigma^2$}

With residuals
\[
\varepsilon_{ij}=y_{ij}^\ast-f(X_{ij})-r_i,
\]
and assuming the prior
\[
\sigma^2 \sim \text{IG}(a_\sigma,b_\sigma),
\]
the full conditional is
\[
\sigma^2\mid\cdot \sim \text{IG}\!\Biggl(a_\sigma+\frac{N}{2},\; b_\sigma+\frac{1}{2}\sum_{i=1}^I\sum_{j\in \mathcal{I}_i}\varepsilon_{ij}^2\Biggr),
\]
where $N=\sum_{i=1}^I n_i$.

\subsection*{3.3. Full Conditional for $\sigma_r^2$}

Assuming
\[
\sigma_r^2 \sim \text{IG}(a_r,b_r),
\]
and using the CAR prior,
\[
\sigma_r^2\mid\cdot \sim \text{IG}\!\Biggl(a_r+\frac{I}{2},\; b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\]

\subsection*{3.4. Metropolis-Hastings Update for $\rho$}

The conditional density (up to proportionality) is
\[
p(\bm{r}\mid\rho,\sigma_r^2) \propto \vert Q(\rho)\vert^{1/2}\exp\!\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\}.
\]
A proposal $\rho^\ast$ is generated (e.g., $\rho^\ast = \rho + \epsilon$ with $\epsilon\sim N(0,\sigma_\rho^2)$) and accepted with probability
\[
\alpha = \min\Biggl\{1,\; \frac{\vert Q(\rho^\ast)\vert^{1/2}\exp\!\left(-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho^\ast)\bm{r}\right)}
{\vert Q(\rho)\vert^{1/2}\exp\!\left(-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\right)}\Biggr\}.
\]

\section*{4. Conclusion}

The full MCMC algorithm for the AFT--SoftBART--CAR model with right censoring consists of:
\begin{enumerate}
  \item Imputing latent failure times for censored data via truncated normal draws.
  \item Updating the nonparametric function $f(\cdot)$ via a SoftBART Gibbs step using working responses $z_{ij}=y_{ij}^\ast-r_i$.
  \item Sampling the spatial random effects $\bm{r}$ from their multivariate normal full conditional.
  \item Sampling $\sigma^2$ and $\sigma_r^2$ from their respective inverse-gamma full conditionals.
  \item Updating $\rho$ using a Metropolis--Hastings step based on the CAR prior.
\end{enumerate}

This completes the derivation and the algorithm description for the AFT--SoftBART--CAR model with right censoring.
























\section{Introduction}
Spatial survival models are useful when survival outcomes exhibit spatial dependence. In this study, we consider an AFT model:
\[
\log T_{ij} = f(X_{ij}) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij} \sim N(0,\sigma^2),
\]
where $f(\cdot)$ is a nonlinear function of covariates (estimated via SoftBART) and the spatial effects $r_i$ follow a CAR prior:
\[
p(\mathbf{r} \mid \sigma_r^2, \rho) \propto |D - \rho W|^{1/2} \exp\Bigl\{-\frac{1}{2\sigma_r^2} \mathbf{r}^\top (D-\rho W) \mathbf{r}\Bigr\}.
\]
Right censoring is introduced in the data generation process. We compare the Bayesian AFT--SoftBART--CAR approach with a standard Cox PH model incorporating a gamma frailty term.

\section{Simulation Study Design}

\subsection{Data Generation}
We simulate data for $n=500$ individuals across $I=25$ spatial regions arranged in a $5 \times 5$ grid. The spatial adjacency matrix $W$ is constructed using standard neighborhood definitions and $D$ is its corresponding diagonal matrix.

\subsubsection{Covariates and True Function}
Two covariates, $X_1$ and $X_2$, are simulated from the Uniform$(0,1)$ distribution. The true function is specified as:
\[
f(x) = \sin(2\pi x_1) + (x_2-0.5)^2.
\]

\subsubsection{Spatial Random Effects}
True spatial effects are generated from a CAR model with parameters:
\[
\rho = 0.6, \quad \sigma_r^2 = 0.4.
\]
That is, 
\[
\mathbf{r} \sim \text{MVN}\Bigl(0, \, \sigma_r^2 (D-\rho W)^{-1}\Bigr).
\]

\subsubsection{Survival Times and Censoring Mechanism}
The true log survival time is generated by:
\[
\log T = f(x) + r_i + \epsilon, \quad \epsilon \sim N(0, 0.5^2).
\]
Thus, the true survival time is $T = \exp\{f(x) + r_i + \epsilon\}$.

\textbf{Censoring:} To incorporate right censoring, censoring times are generated independently from an exponential distribution with rate $\lambda = 0.05$. The observed time is then given by:
\[
T^{\text{obs}} = \min\{T,\, C\},
\]
with the censoring indicator defined as:
\[
\delta = \begin{cases} 1, & \text{if } T \le C, \\ 0, & \text{if } T > C. \end{cases}
\]
This mechanism creates a scenario where some survival times are only known to exceed the observed censoring time.

\subsection{Models Considered}
\subsubsection{AFT--SoftBART--CAR Model}
The AFT model is:
\[
\log T_{ij} = f(X_{ij}) + r_i + \varepsilon_{ij},
\]
where $f(\cdot)$ is estimated nonparametrically via SoftBART and the spatial effects $r_i$ follow a CAR prior. The MCMC algorithm includes data augmentation to impute latent log times for censored observations.

\subsubsection{Cox PH Model with Frailty}
The Cox PH model with a gamma frailty term is given by:
\[
\lambda(t\mid x, r_i) = \lambda_0(t)\exp(x^\top\beta + r_i).
\]
The marginal survival function after integrating out the frailties is:
\[
S(t\mid x) = \Bigl[1+\theta\, \hat{H}_0(t)\exp(x^\top\beta)\Bigr]^{-1/\theta},
\]
where $\theta$ is the frailty variance and $\hat{H}_0(t)$ is the estimated baseline cumulative hazard.

\section{Implementation}
The simulation study was implemented in R. Below are excerpts of the key code sections (the complete code is provided in the Appendix).

\subsection{AFT--SoftBART--CAR MCMC Function}
\begin{lstlisting}[language=R, caption={AFT--SoftBART--CAR MCMC sampler}]
AFT_mixed_CAR_softbart <- function(time, status, X, group, W, X_test, group_test = group,
                                   n_iter = 3000, burn_in = 500, thin = 5, ...){
  # Convert observed times to log-scale
  y <- log(time)
  y_latent <- y   # Initialize latent log times
  # Define groups and indices, precompute D, etc.
  # Initialize SoftBART forest and spatial random effects (r)
  # MCMC loop:
  for (iter in 1:n_iter) {
    # (A) Data Augmentation: For censored observations, impute latent y's via truncated normals.
    # (B) Update f(.) via SoftBART using the working response (y_latent - r)
    # (C) Update spatial effects r using a CAR full conditional
    # (D) Update sigma^2 from its full conditional
    # (E) Update sigma_r^2 from its full conditional
    # (F) Update rho via Metropolis-Hastings
    # (G) Save posterior samples after burn-in and thinning.
  }
  return(list(f_train = f_samples, f_test = f_test_samples, r = r_samples,
              sigma2 = sigma2_samples, sigma_r2 = sigma_r2_samples, rho = rho_samples,
              forest = forest))
}
\end{lstlisting}

\subsection{Prediction Functions}
\begin{lstlisting}[language=R, caption={Prediction for AFT--SoftBART--CAR model}]
predict_AFT_CAR <- function(mcmc_output, X_new, group_new, time_grid = seq(0.1, 100, length.out = 100)){
  # For each MCMC sample, compute predicted log survival time = f(X_new) + r (matching group)
  # Compute survival probabilities: S(t) = 1 - Phi((log(t) - (f+r))/sigma)
  # Summarize by computing the posterior mean and 95% credible bands.
}
\end{lstlisting}

\begin{lstlisting}[language=R, caption={Prediction for Cox PH with Frailty model}]
predict_cox_surv <- function(cox_model, newdata, time_grid, theta_default = 0.5){
  # Extract baseline cumulative hazard using basehaz()
  # Interpolate to time_grid; obtain H0(t)
  # Attempt to extract theta (frailty variance); if missing, use theta_default
  # Compute linear predictors lp
  # Compute marginal survival: S(t|x) = [1 + theta * H0(t) * exp(lp)]^(-1/theta)
}
\end{lstlisting}

\section{Results}
\subsection{Median Survival Prediction}
We compared the median survival times predicted by the two models to the true medians (computed as $\exp(f(x) + r)$). For example, the AFT--SoftBART--CAR model produced an RMSE of \textbf{XX} while the Cox PH with frailty yielded an RMSE of \textbf{YY} (replace with actual values).

\subsection{Survival Curve Comparison}
For selected individuals, we compared the entire survival curves. Figure~\ref{fig:surv_curves} displays the following:
\begin{itemize}
    \item \textbf{True survival curve:} Calculated using the known $f(x)$, $r$, and $\sigma$.
    \item \textbf{AFT--SoftBART--CAR:} The estimated survival curve is shown with a blue line and a blue shaded 95\% credible band.
    \item \textbf{Cox PH with frailty:} The estimated marginal survival curve is shown in dark green.
\end{itemize}

\begin{figure}[ht]
\centering
\includegraphics[width=0.32\textwidth]{ind1.pdf}
\includegraphics[width=0.32\textwidth]{ind2.pdf}
\includegraphics[width=0.32\textwidth]{ind3.pdf}
\caption{Comparison of survival curves for three individuals: true (black), AFT--SoftBART--CAR (blue with 95\% credible bands), and Cox PH with frailty (dark green).}
\label{fig:surv_curves}
\end{figure}

\subsection{Discussion}
The simulation results indicate that the AFT--SoftBART--CAR model, which explicitly handles right censoring via data augmentation, captures both nonlinear effects and spatial heterogeneity accurately. The estimated survival curves and credible bands closely follow the true curves. In contrast, while the Cox PH model with frailty performs reasonably well for median survival predictions, it appears less flexible in capturing the nonlinear effects, as evidenced by discrepancies in the survival curves.

\section{Conclusion}
We simulated spatial survival data with right censoring and compared a flexible Bayesian AFT model (using SoftBART with CAR random effects) with a Cox PH model that includes a frailty term. Our results suggest that the AFT--SoftBART--CAR model offers improved recovery of the true survival curves and provides meaningful uncertainty quantification through credible bands.

\appendix
\section{Complete R Code}
\label{appendix:rcode}
\begin{verbatim}
# (The complete R code is included here)
# See file "AFT_BART_Simulation.R" for the full implementation.
\end{verbatim}









\section{Simulation Study and Estimation of Causal Estimands}

In this section, we describe a comprehensive simulation study designed to assess our Bayesian causal inference methodology for spatially clustered survival data. Our goal is to generate survival data from a known data‐generating mechanism, fit our nonparametric Bayesian model, and then recover various causal estimands with associated credible intervals. In the following subsections, we detail the data generation process, the derivation of the estimands, and the method for obtaining their estimates from the posterior draws.

\subsection{Data Generation Process}

We assume that the true survival times, \(T_{ij}\), for subject \(j\) in spatial group \(i\) follow an accelerated failure time (AFT) model. On the log scale, the model is
\begin{equation} \label{eq:logT}
y_{ij} = \log T_{ij} = f(X_{ij}, Z_{ij}) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij} \sim N(0,\sigma^2),
\end{equation}
where:
\begin{itemize}
    \item \(X_{ij} = (X_{1ij}, X_{2ij})^\top\) are covariates generated from a standard normal distribution, i.e., \(X_{kij} \sim N(0,1)\) for \(k=1,2\).
    \item \(Z_{ij}\) is a binary treatment indicator assigned according to a logistic model based solely on \(X_{1ij}\). Specifically, the propensity score is given by
    \[
    p_{ij} = \text{expit}(0.5\,X_{1ij}) = \frac{1}{1 + \exp(-0.5\,X_{1ij})},
    \]
    and the treatment is generated as \(Z_{ij} \sim \text{Bernoulli}(p_{ij})\).
    \item The true regression function is defined as
    \[
    f(X_{ij}, Z_{ij}) = X_{1ij} + 2\,Z_{ij} + \sin(X_{2ij}),
    \]
    which does \emph{not} depend on the estimated propensity score. This function represents the deterministic part of the log survival time.
    \item \(r_i\) denotes the spatial random effect for area \(i\). The spatial effects are generated via a conditional autoregressive (CAR) model. Let \(W\) be an \(I\times I\) spatial adjacency matrix and \(D\) the corresponding diagonal matrix with \(D_{ii} = \sum_{j=1}^{I} W_{ij}\). Then, the CAR prior precision matrix is
    \[
    Q = D - \rho W,
    \]
    and the covariance matrix is given by
    \[
    \Sigma_r = \sigma_r^2\, Q^{-1}.
    \]
    We simulate the spatial effects as
    \[
    \mathbf{r} = (r_1, \dots, r_I)^\top \sim N(\mathbf{0}, \Sigma_r).
    \]
    \item The residual error \(\varepsilon_{ij}\) is assumed to follow a normal distribution with variance \(\sigma^2\).
\end{itemize}

Thus, each subject's log survival time is given by
\[
y_{ij} = f(X_{ij}, Z_{ij}) + r_i + \varepsilon_{ij},
\]
and the observed survival time is
\[
T_{ij} = \exp(y_{ij}).
\]
In our simulations, we assume no censoring (i.e., the censoring indicator \(\delta_{ij} = 1\) for all subjects).

\subsection{Model Fitting Using \texttt{AFT\_mixed\_CAR\_softbart\_causal}}

To fit the data, we employ the function \texttt{AFT\_mixed\_CAR\_softbart\_causal}, which implements our Bayesian inference framework. This function performs the following steps:
\begin{enumerate}
    \item \textbf{Propensity Score Estimation:}  
    A separate SoftBART model is used to estimate the propensity score \(\hat{e}(X_{ij})\) by regressing the treatment \(Z_{ij}\) on the covariates \(X_{ij}\). Although SoftBART is primarily a regression tool, its predictions are transformed via the logistic (expit) function to yield estimates in \([0,1]\).

    \item \textbf{Augmented Covariate Construction:}  
    The original covariate matrix \(X_{ij}\) is augmented with the treatment indicator \(Z_{ij}\) and the estimated propensity score \(\hat{e}(X_{ij})\). The resulting design matrix is used in the SoftBART model for the nonparametric function \(f(\cdot)\).

    \item \textbf{Nonparametric Function and Spatial Effects:}  
    The model assumes that
    \[
    \mu_{ij} = f(X_{ij}, Z_{ij}, \hat{e}(X_{ij})) + r_i,
    \]
    where \(r_i\) are the spatial effects updated via a CAR prior. The residual variance \(\sigma^2\) is also estimated from the data, and a Metropolis–Hastings update is employed for the spatial autocorrelation parameter \(\rho\).
    
    \item \textbf{MCMC Sampling:}  
    The function runs an MCMC algorithm that updates the nonparametric function \(f(\cdot)\), the spatial random effects \(r_i\), and the variance parameters. The output consists of posterior samples of \(f\), \(r\), and \(\sigma^2\).
\end{enumerate}

\subsection{Estimation of Causal Estimands}

Our objective is to estimate both marginal and conditional causal effects. Let us define the potential outcomes under treatment \(z \in \{0,1\}\) as:
\[
y_{ij}^{(z)} = f^{(z)}(X_{ij}) + r_i + \varepsilon_{ij}, \quad T_{ij}^{(z)} = \exp\{y_{ij}^{(z)}\},
\]
where \(f^{(z)}(X_{ij})\) is obtained by setting the treatment indicator to \(z\) in the augmented design matrix.

Under the log-normal model, for a given subject \(ij\) with
\[
\mu_{ij}^{(z)} = f^{(z)}(X_{ij}) + r_i \quad \text{and} \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\]
the distribution of \(\log T_{ij}^{(z)}\) is \(N(\mu_{ij}^{(z)},\sigma^2)\). Hence, we have:
\begin{itemize}
    \item \textbf{Survival Function:}  
    \[
    S^{(z)}(t) = \Pr(T_{ij}^{(z)} > t) = 1 - \Phi\left(\frac{\log t - \mu_{ij}^{(z)}}{\sigma}\right),
    \]
    where \(\Phi(\cdot)\) is the standard normal cumulative distribution function.

    \item \textbf{Expected Survival Time:}  
    \[
    E[T_{ij}^{(z)}] = \exp\left(\mu_{ij}^{(z)} + \frac{\sigma^2}{2}\right).
    \]

    \item \textbf{Restricted Mean Survival Time (up to \(t^*\)):}  
    \[
    E\left[\min\left(T_{ij}^{(z)}, t^*\right)\right] = \exp\left(\mu_{ij}^{(z)} + \frac{\sigma^2}{2}\right)\Phi\left(\frac{\log t^* - \mu_{ij}^{(z)} - \sigma^2}{\sigma}\right) + t^*\left\{1 - \Phi\left(\frac{\log t^* - \mu_{ij}^{(z)}}{\sigma}\right)\right\}.
    \]
\end{itemize}

From these, we define the following \emph{marginal} causal estimands:
\begin{enumerate}
    \item \textbf{Survival Probability Causal Effect (SPCE)} at time \(t\):
    \[
    \Delta SPCE(t) = E\left[S^{(1)}(t)\right] - E\left[S^{(0)}(t)\right],
    \]
    where the expectation is taken over the distribution of covariates and spatial effects.

    \item \textbf{Average Causal Effect (ACE):}
    \[
    \Delta ACE = E\left[E[T^{(1)}]\right] - E\left[E[T^{(0)}]\right].
    \]

    \item \textbf{Restricted Average Causal Effect (RACE)} (up to time \(t^*\)):
    \[
    \Delta RACE = E\left[E\left[\min\left(T^{(1)}, t^*\right)\right]\right] - E\left[E\left[\min\left(T^{(0)}, t^*\right)\right]\right].
    \]
\end{enumerate}

Additionally, we define \emph{conditional} estimands that are computed subject-by-subject, i.e., conditioning on \(X\) and \(r\):
\begin{align*}
\Delta CSPCE(t, X, r) &= S^{(1)}(t \mid X, r) - S^{(0)}(t \mid X, r), \\
\Delta CACE(X, r) &= E[T^{(1)} \mid X, r] - E[T^{(0)} \mid X, r], \\
\Delta CRACE(X, r) &= E\left[\min\left(T^{(1)}, t^*\right) \mid X, r\right] - E\left[\min\left(T^{(0)}, t^*\right) \mid X, r\right].
\end{align*}

\paragraph{Estimation via Posterior Draws:}  
Our fitting procedure yields \(M\) posterior draws for the parameters:
\begin{itemize}
    \item \(\{f^{(m)}(\cdot)\}_{m=1}^M\) from SoftBART,
    \item \(\{r_i^{(m)}\}_{m=1}^M\) for each spatial group, and
    \item \(\{\sigma^{2(m)}\}_{m=1}^M\) for the residual variance.
\end{itemize}
For each draw \(m\), we form the potential outcomes by setting
\[
\mu_{ij}^{(z, m)} = f^{(m)}(X_{ij}, z, \hat{e}(X_{ij})) + r_{i}^{(m)},
\]
for \(z \in \{0,1\}\). Then, using the formulas above, we compute
\[
S_{ij}^{(z, m)} = 1 - \Phi\left(\frac{\log t - \mu_{ij}^{(z, m)}}{\sigma^{(m)}}\right),
\]
\[
E[T_{ij}^{(z, m)}] = \exp\left(\mu_{ij}^{(z, m)} + \frac{\sigma^{2(m)}}{2}\right),
\]
and
\[
E\left[\min\left(T_{ij}^{(z, m)}, t^*\right)\right] = \exp\left(\mu_{ij}^{(z, m)} + \frac{\sigma^{2(m)}}{2}\right)\Phi\left(\frac{\log t^* - \mu_{ij}^{(z, m)} - \sigma^{2(m)}}{\sigma^{(m)}}\right) + t^*\left\{1 - \Phi\left(\frac{\log t^* - \mu_{ij}^{(z, m)}}{\sigma^{(m)}}\right)\right\}.
\]
Averaging these quantities over subjects (and then over posterior draws) gives us estimates of the marginal estimands. The conditional estimands are computed at the subject level using the individual predicted values \(\mu_{ij}^{(z, m)}\).

\subsection{Implementation in R}

The following R functions implement the estimation procedure:

\begin{itemize}
    \item \texttt{compute\_surv}: Computes the survival probability \(S(t)\) for a given \(\mu\) and \(\sigma\) using
    \[
    S(t) = 1 - \Phi\left(\frac{\log t - \mu}{\sigma}\right).
    \]
    \item \texttt{compute\_expected\_T}: Calculates the expected survival time
    \[
    E[T] = \exp\left(\mu + \frac{\sigma^2}{2}\right).
    \]
    \item \texttt{compute\_restricted\_mean}: Returns the restricted mean survival time up to \(t^*\) using the formula described above.
    \item \texttt{estimate\_potential\_outcomes}: For each subject, this function uses the fitted model to generate predictions of \(f\) under both treatment regimes by altering the treatment indicator in the augmented covariate matrix. It then adds the corresponding spatial effect \(r_i\) from each MCMC draw to form the predicted \(\mu_{ij}^{(z)}\) matrices.
    \item \texttt{compute\_estimands}: For each posterior draw \(m\), the function computes subject-specific values of \(S^{(z)}\), \(E[T^{(z)}]\), and \(E[\min(T^{(z)},t^*)]\). Averaging over subjects yields the marginal estimands for that draw. Finally, summary statistics (posterior mean and 95\% credible intervals) are computed over the \(M\) draws.
\end{itemize}

For comparison, we also compute the true estimands using the known data-generating functions. In our simulation, the true function is given by
\[
f_{\text{true}}(X_{ij}, Z_{ij}) = X_{1ij} + 2\,Z_{ij} + \sin(X_{2ij}),
\]
and the true potential outcomes are computed by setting
\[
\mu_{ij}^{(z)} = f_{\text{true}}(X_{ij}, z) + r_i,
\]
with \(r_i\) being the true spatial effects and using the true residual standard deviation \(\sigma\).

\subsection{Summary of the Simulation Study}

In summary, our simulation study proceeds as follows:
\begin{enumerate}
    \item \textbf{Data Generation:}  
    We simulate \(n\) subjects in \(I\) spatial groups. Covariates \(X_{ij}\) and treatment \(Z_{ij}\) are generated, and the true log survival time is given by
    \[
    y_{ij} = f_{\text{true}}(X_{ij}, Z_{ij}) + r_i + \varepsilon_{ij}.
    \]
    Spatial random effects \(r_i\) are drawn from a CAR model, and \(\varepsilon_{ij}\sim N(0,\sigma^2)\).

    \item \textbf{Model Fitting:}  
    The generated data are fitted using \texttt{AFT\_mixed\_CAR\_softbart\_causal}, which first estimates the propensity scores and then fits the nonparametric function \(f\) and spatial effects using MCMC.

    \item \textbf{Estimation of Potential Outcomes:}  
    For each posterior draw \(m\), the potential outcomes under \(Z=1\) and \(Z=0\) are obtained by constructing
    \[
    \mu_{ij}^{(z,m)} = f^{(m)}(X_{ij}, z, \hat{e}(X_{ij})) + r_i^{(m)}.
    \]
    
    \item \textbf{Causal Estimands:}  
    Using the log-normal properties, we compute for each draw:
    \begin{align*}
    S_{ij}^{(z,m)} &= 1 - \Phi\left(\frac{\log t - \mu_{ij}^{(z,m)}}{\sigma^{(m)}}\right), \\
    E[T_{ij}^{(z,m)}] &= \exp\left(\mu_{ij}^{(z,m)} + \frac{(\sigma^{(m)})^2}{2}\right), \\
    E\left[\min\left(T_{ij}^{(z,m)}, t^*\right)\right] &= \exp\left(\mu_{ij}^{(z,m)} + \frac{(\sigma^{(m)})^2}{2}\right)\Phi\left(\frac{\log t^* - \mu_{ij}^{(z,m)} - (\sigma^{(m)})^2}{\sigma^{(m)}}\right) \\
    &\quad + t^*\left\{1 - \Phi\left(\frac{\log t^* - \mu_{ij}^{(z,m)}}{\sigma^{(m)}}\right)\right\}.
    \end{align*}
    Averaging these quantities across subjects and MCMC draws yields estimates of the marginal estimands \(\Delta SPCE(t)\), \(\Delta ACE\), and \(\Delta RACE\). Conditional estimands are computed on a subject-by-subject basis and summarized with their posterior means and credible intervals.

    \item \textbf{Comparison with True Estimands:}  
    Finally, the true estimands are calculated using the known data-generating parameters and compared with the estimated values.
\end{enumerate}

This detailed mathematical derivation and implementation illustrate how every term (such as \(\mu\), \(\sigma\), \(r_i\)) is defined and used in both the data generation and estimand estimation processes, thereby providing a clear link between the model and the causal estimands under investigation.






\section{Simulation Study}

In this section, we evaluate the performance of our proposed Bayesian Accelerated Failure Time (AFT) model with spatial Conditional Autoregressive (CAR) random effects and a nonparametrically estimated function \( f(\cdot) \) via SoftBart. Our simulation design mimics realistic spatial survival data settings, where subjects are clustered in spatial regions, and treatment assignment is determined based on a set of covariates. We focus on estimating three causal estimands: the Causal Survival Probability Contrast at time \( t \) (CSPCE), the Causal Average Causal Effect (CACE), and the Causal Restricted Average Causal Effect (CRACE).

\subsection{Data Generation}

We generate data for \( n = 200 \) subjects, each with a \( p = 2 \)–dimensional covariate vector \( X = (X_1, X_2) \). The covariates are generated as follows:
\[
X_1, X_2 \stackrel{\text{i.i.d.}}{\sim} N(0,1).
\]
A binary treatment indicator \( Z \) is assigned with equal probability:
\[
Z \sim \text{Bernoulli}(0.5).
\]
Subjects are allocated to one of \( I = 10 \) spatial clusters. The spatial dependence among clusters is induced through a simple adjacency matrix \( W \) where cluster \( i \) is assumed to be adjacent to cluster \( i+1 \) (with appropriate symmetry).

The survival times \( T \) are generated from a lognormal model:
\[
\log T = f(X,Z) + r + \epsilon, \quad \epsilon \sim N(0, \sigma^2),
\]
with
\[
f(X,Z) = 0.5 X_1 - 0.3 X_2 + 1.0 \cdot Z.
\]
The spatial random effects \( r \) are generated by drawing each cluster effect from
\[
r \sim N(0, 0.5^2),
\]
and the residual variance is set to \( \sigma^2 = 0.25 \). No censoring is imposed in the simulation.

\subsection{Model Fitting}

We fit the proposed model using our custom function \texttt{AFT\_mixed\_CAR\_softbart\_causal()}, which jointly estimates:
\begin{enumerate}
  \item The nonparametric function \( f(\cdot) \) using SoftBart.
  \item The spatial random effects \( r \) via a CAR prior.
  \item The treatment propensity scores using SoftBart to model the latent propensity, which are then transformed via the logistic (expit) function.
\end{enumerate}

The augmented covariate matrix is constructed by concatenating \( X \), the treatment indicator \( Z \), and the estimated propensity score \( \hat{e}(X) \). MCMC is run for 6000 iterations, with a burn-in period of 1000 iterations and thinning set to every 5 iterations. The spatial autocorrelation parameter \( \rho \) is updated via a Metropolis-Hastings step with a proposal standard deviation of 0.05.

\subsection{Estimation of Causal Effects}

For causal inference, we consider three estimands:
\begin{enumerate}
  \item \textbf{CSPCE (Causal Survival Probability Contrast)}:
  \[
  \Delta \text{CSPCE}(t, X, r) = S(1)(t \mid X, r) - S(0)(t \mid X, r),
  \]
  where the survival function for the lognormal model is given by
  \[
  S(t \mid X, r) = 1 - \Phi\left(\frac{\log(t) - \left(f(X,Z) + r\right)}{\sqrt{\sigma^2}}\right).
  \]

  \item \textbf{CACE (Causal Average Causal Effect)}:
  \[
  \Delta \text{CACE}(X, r) = E[T(1) \mid X, r] - E[T(0) \mid X, r],
  \]
  with
  \[
  E[T \mid X, r] = \exp\left(f(X,Z) + r + \frac{\sigma^2}{2}\right).
  \]

  \item \textbf{CRACE (Causal Restricted Average Causal Effect)}:
  \[
  \Delta \text{CRACE}(X, r) = E\left[\min(T(1), t^*) \mid X, r\right] - E\left[\min(T(0), t^*) \mid X, r\right],
  \]
  where
  \[
  E\left[\min(T, t^*) \mid X, r\right] = \exp\left(f(X,Z) + r + \frac{\sigma^2}{2}\right) \Phi\left(\frac{\log(t^*) - f(X,Z) - r - \sigma^2}{\sqrt{\sigma^2}}\right) + t^* \left[1 - \Phi\left(\frac{\log(t^*) - f(X,Z) - r}{\sqrt{\sigma^2}}\right)\right].
  \]
\end{enumerate}

Posterior estimates and 95\% credible intervals for these estimands are obtained using the functions \texttt{getCSPCE}, \texttt{getCACE}, and \texttt{getCRACE}. In these functions, predictions are extracted from each MCMC iteration via the routine \texttt{predict\_iteration()}, which accepts the augmented covariate matrix and an iteration index. This change allows us to properly capture the uncertainty in the estimates.

\subsection{Results and Visualization}

For each simulated dataset, we compute the true causal effects using the known data generating mechanism. We then compare these with the posterior summaries obtained from the fitted model. In our evaluation, we focus on:
\begin{itemize}
  \item The estimated versus true CSPCE as a function of time \( t \) for a subject with the median covariate values.
  \item The estimated versus true CRACE as a function of the threshold \( t^* \) across the spatial clusters.
\end{itemize}

Figures~\ref{fig:cspce} and \ref{fig:crace} display these comparisons. In Figure~\ref{fig:cspce}, the estimated CSPCE is shown as a solid blue line with a shaded 95\% credible interval, overlaid with the true CSPCE (dashed black line) for each cluster. Figure~\ref{fig:crace} shows the corresponding results for CRACE. The plots demonstrate that our model successfully recovers the underlying causal effects, with the credible intervals appropriately capturing the estimation uncertainty.

\subsection{Discussion}

The simulation study illustrates that the proposed Bayesian AFT model with spatial CAR random effects and nonparametric estimation via SoftBart performs well in estimating causal effects from spatial survival data. The incorporation of the propensity score in the augmented covariate matrix improves the robustness of the inference, while the use of \texttt{predict\_iteration()} enables proper posterior uncertainty quantification. Overall, the model provides reliable estimates of CSPCE, CACE, and CRACE, even in the presence of spatially correlated data.

\section{Conclusion}

In conclusion, our extensive simulation study provides strong evidence that the proposed methodology accurately recovers the true causal effects under realistic data generating scenarios. These findings support the application of our approach to real-world spatial survival data and motivate further research into more complex spatial structures and high-dimensional covariate settings.





\section{Simulation Study: Complex Design}

In this simulation study, we evaluate the performance of our proposed Bayesian Accelerated Failure Time (AFT) model with spatial Conditional Autoregressive (CAR) random effects and nonparametric estimation via SoftBart under a complex data generating process. In this design, the true function \( f(X,Z) \) is nonlinear and exhibits interactions between confounders and treatment. Furthermore, the spatial random effects \( r \) are generated from a CAR model, which introduces spatial correlation among clusters.

\subsection{Data Generation}

We generate data for \( n = 300 \) subjects with \( p = 3 \) covariates. The covariates are generated as follows:
\[
X_1, X_2, X_3 \stackrel{\text{i.i.d.}}{\sim} N(0,1).
\]
The treatment indicator \( Z \) is assigned based on a logistic model:
\[
P(Z=1 \mid X) = \text{expit}(0.3 X_1 - 0.2 X_2 + 0.1 X_3),
\]
where \(\text{expit}(x)=1/(1+e^{-x})\).

Subjects are grouped into \( I = 10 \) spatial clusters. The spatial dependence is incorporated through an adjacency matrix \( W \) defined by a simple chain structure: each cluster \( i \) is assumed adjacent to clusters \( i-1 \) and \( i+1 \) (with adjustments at the boundaries). Let \( D \) denote the diagonal matrix of row sums of \( W \). The spatial random effects \( \mathbf{r} = (r_1,\ldots, r_I)' \) are then generated from a CAR model:
\[
\mathbf{r} \sim \text{MVN}\Big( \mathbf{0},\, \sigma_r^2 (D - \rho W)^{-1}\Big),
\]
with true values \(\rho_{\text{true}}=0.7\) and \(\sigma_r^2=0.5\).

The true outcome function is specified to be nonlinear with interactions:
\[
f(X,Z) = \sin(\pi X_1 X_2) + \log(1+\exp(X_3)) + Z\Big(0.5 X_1^2 - 0.3 X_2\Big).
\]
Survival times are generated from a lognormal model:
\[
\log T = f(X,Z) + r + \epsilon, \quad \epsilon \sim N(0, \sigma^2),
\]
with \(\sigma^2=0.25\) and \(r\) corresponding to the spatial random effect for the subject's cluster. The observed survival time is then \( T = \exp(\log T) \) (we assume no censoring).

\subsection{Model Fitting and Causal Effect Estimation}

We fit the Bayesian AFT model with spatial CAR random effects using our function \texttt{AFT\_mixed\_CAR\_softbart\_causal()}, which uses SoftBart for nonparametric estimation of \( f(\cdot) \) and incorporates the estimated propensity score into an augmented covariate matrix. Posterior inference is performed via MCMC, and predictions from each iteration are obtained using the routine \texttt{predict\_iteration()}.

We focus on estimating the following causal estimands:
\begin{enumerate}
  \item \textbf{CSPCE (Causal Survival Probability Contrast):}
  \[
  \Delta \text{CSPCE}(t, X, r) = S(1)(t \mid X, r) - S(0)(t \mid X, r),
  \]
  where
  \[
  S(t\mid X,r) = 1-\Phi\Big(\frac{\log(t)-\big(f(X,Z)+r\big)}{\sqrt{\sigma^2}}\Big).
  \]
  
  \item \textbf{CACE (Causal Average Causal Effect):}
  \[
  \Delta \text{CACE}(X, r) = E[T(1)\mid X, r] - E[T(0)\mid X, r],
  \]
  with
  \[
  E[T\mid X, r] = \exp\Big(f(X,Z)+r+\frac{\sigma^2}{2}\Big).
  \]
  
  \item \textbf{CRACE (Causal Restricted Average Causal Effect):}
  \[
  \Delta \text{CRACE}(X, r) = E\Big[\min(T(1),t^*)\mid X, r\Big]-E\Big[\min(T(0),t^*)\mid X, r\Big],
  \]
  where
  \[
  E\Big[\min(T,t^*)\mid X,r\Big]=\exp\Big(f(X,Z)+r+\frac{\sigma^2}{2}\Big)\,\Phi\Big(\frac{\log(t^*)-f(X,Z)-r-\sigma^2}{\sqrt{\sigma^2}}\Big) + t^*\Big[1-\Phi\Big(\frac{\log(t^*)-f(X,Z)-r}{\sqrt{\sigma^2}}\Big)\Big].
  \]
\end{enumerate}

We obtain posterior summaries (point estimates and 95\% credible intervals) for these estimands using the functions \texttt{getCSPCE}, \texttt{getCACE}, and \texttt{getCRACE}.

\subsection{Implementation in R}

The following R code implements the simulation study:



\subsection{Results and Discussion}

Figures~\ref{fig:cspce_complex}, \ref{fig:cace_complex}, and \ref{fig:crace_complex} display the comparison between the estimated and true causal effects. In each cluster:
\begin{itemize}
  \item The estimated CSPCE (solid blue line with shaded 95\% credible intervals) closely tracks the true CSPCE (dashed black line) over time.
  \item The estimated CACE (blue points with error bars) aligns well with the true CACE.
  \item Similarly, the estimated CRACE versus the threshold \( t^* \) accurately recovers the true CRACE.
\end{itemize}

These results indicate that our model effectively recovers the complex nonlinear relationship and interaction effects present in the data while properly accounting for spatial correlation via the CAR prior.

\subsection{Conclusion}

The simulation study with a more complex design demonstrates that the proposed Bayesian AFT model is robust to nonlinearities, interactions, and spatial dependencies. The use of \texttt{predict\_iteration()} in the \texttt{getCSPCE}, \texttt{getCACE}, and \texttt{getCRACE} functions allows for accurate uncertainty quantification. Overall, the model shows excellent performance in recovering the true causal effects, supporting its application to complex spatial survival data.













\section{Model}

In this section we describe our Bayesian model for causal inference on spatially clustered survival data. We first outline the likelihood for survival times under an accelerated failure time (AFT) formulation that incorporates flexible regression via SoftBART and spatial random effects, and then specify the prior distributions. Finally, we detail the full conditional derivations and present the Metropolis-within-Gibbs sampling algorithm used for posterior inference.

\subsection{Model Specification}

We assume that the true survival times $\{T_{ij}\}$ (for areas $i=1,\ldots,I$ and subjects $j=1,\ldots,n_i$) satisfy the AFT model
\begin{equation} \label{eq:aft}
\log T_{ij} = f\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij})\Bigr) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\end{equation}
where
\begin{itemize}
    \item $X_{ij}$ is a vector of subject-specific covariates,
    \item $Z_{ij}$ is a binary treatment indicator,
    \item $\hat{e}(X_{ij})$ denotes the propensity score estimated in a first-stage SBART regression of $Z_{ij}$ on $X_{ij}$,
    \item $f(\cdot)$ is a flexible, nonparametric function modeled via SoftBART (i.e., a sum-of-trees model with soft decision rules),
    \item $r_i$ is the spatial random effect for area $i$, and
    \item $\varepsilon_{ij}$ are i.i.d. errors.
\end{itemize}

Because survival times are subject to right censoring, we observe
\[
T_{ij}^{\text{obs}} = \min(T_{ij},C_{ij}), \quad \delta_{ij} = I(T_{ij}\le C_{ij}),
\]
and work on the log-scale by letting
\[
y_{ij} = \log T_{ij}^{\text{obs}}.
\]
Following standard data augmentation approaches (e.g., \cite{tanner1987calculation}), we introduce latent variables $y_{ij}^\ast$ so that
\[
y_{ij}^\ast = \log T_{ij} =
\begin{cases}
y_{ij}, & \delta_{ij}=1, \\
\text{latent, } y_{ij}^\ast > y_{ij}, & \delta_{ij}=0.
\end{cases}
\]

\subsection{Prior Distributions}

We complete the model by assigning the following priors:

\paragraph{Spatial Effects.} We impose a conditional autoregressive (CAR) prior on the vector $\bm{r}=(r_1,\ldots,r_I)^\top$:
\begin{equation} \label{eq:carprior}
p(\bm{r}\mid\sigma_r^2,\rho) \propto |Q(\rho)|^{1/2} \exp\Bigl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Bigr\},
\end{equation}
where the precision matrix is defined as
\[
Q(\rho)=D-\rho\,W,
\]
with $W$ the spatial adjacency matrix and $D$ the diagonal matrix whose $i$th entry is $D_{ii}=\sum_{j}W_{ij}$.

\paragraph{Error Variance.} We assume
\[
\sigma^2 \sim \text{IG}(a_\sigma,b_\sigma).
\]

\paragraph{Spatial Variance.} Similarly,
\[
\sigma_r^2 \sim \text{IG}(a_r,b_r).
\]

\paragraph{CAR Parameter.} The spatial dependence parameter $\rho$ is assigned a uniform prior on its admissible range (typically, $\rho\in(0,1)$).

\paragraph{Flexible Function.} The function $f(\cdot)$ is modeled via SoftBART, that is,
\[
f(X_{ij}, Z_{ij}, \hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij}); T_h, M_h\Bigr),
\]
with each tree $g(\cdot;T_h,M_h)$ having its own structure $T_h$ and terminal node parameters $M_h$. We assign regularizing priors to the tree structures and the terminal node parameters as in \cite{chipman2010bart}.

\subsection{Posterior Inference}

Let $\theta=\{f(\cdot),\bm{r},\sigma^2,\sigma_r^2,\rho\}$ denote the collection of all model parameters. The joint posterior distribution is given by
\begin{equation} \label{eq:posterior}
p\Bigl(\theta, \{y_{ij}^\ast\}_{\delta_{ij}=0}\mid \{y_{ij}\},X,Z\Bigr)
\propto L\Bigl(\{y_{ij}^\ast\}\mid f(\cdot),\bm{r},\sigma^2\Bigr)
\, p\bigl(f(\cdot)\bigr)
\, p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr)
\, p(\sigma^2)\, p(\sigma_r^2)\, p(\rho),
\end{equation}
where the likelihood (augmented for censored observations) is
\begin{equation}
L\Bigl(\{y_{ij}^\ast\}\mid f(\cdot),\bm{r},\sigma^2\Bigr)=\prod_{i=1}^{I}\prod_{j=1}^{n_i}\phi\Bigl(y_{ij}^\ast;f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr)
\, I\Bigl\{y_{ij}^\ast\in \mathcal{A}_{ij}\Bigr\},
\end{equation}
with $\phi(\cdot;\mu,\sigma^2)$ denoting the normal density and
\[
\mathcal{A}_{ij}=
\begin{cases}
\{y_{ij}\}, & \delta_{ij}=1,\\[1mm]
(y_{ij},\infty), & \delta_{ij}=0.
\end{cases}
\]

We now describe the full conditionals for each component of the model.

\paragraph{Latent Variables.} For each censored observation ($\delta_{ij}=0$), the full conditional for $y_{ij}^\ast$ is
\begin{equation} \label{eq:ystar}
y_{ij}^\ast\mid \cdot \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) \quad \text{truncated to } (y_{ij},\infty).
\end{equation}

\paragraph{Spatial Random Effects.} For each area $i$, combining the likelihood with the CAR prior in (\ref{eq:carprior}) yields
\begin{equation} \label{eq:rfullcond}
r_i \mid \cdot \sim N\Biggl(\mu_{r_i},\, \tau_{r_i}^2\Biggr),
\end{equation}
with
\[
\tau_{r_i}^2=\left(\frac{n_i}{\sigma^2}+\frac{Q_{ii}}{\sigma_r^2}\right)^{-1},\quad
\mu_{r_i}=\tau_{r_i}^2\left\{\frac{1}{\sigma^2}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))\Bigr)
-\frac{1}{\sigma_r^2}\sum_{k\neq i}Q_{ik}\,r_k\right\}.
\]

\paragraph{Error Variance.} The full conditional for $\sigma^2$ is given by
\begin{equation} \label{eq:sigma2}
\sigma^2 \mid \cdot \sim \text{IG}\Biggl(a_\sigma+\frac{N}{2},\,b_\sigma+\frac{1}{2}\sum_{i=1}^{I}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))-r_i\Bigr)^2\Biggr),
\end{equation}
where $N=\sum_{i=1}^{I}n_i$.

\paragraph{Spatial Variance.} Similarly, the full conditional for $\sigma_r^2$ is
\begin{equation} \label{eq:sigmar2}
\sigma_r^2 \mid \cdot \sim \text{IG}\Biggl(a_r+\frac{I}{2},\,b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\end{equation}

\paragraph{CAR Parameter.} The full conditional for $\rho$ is not available in closed form and is updated via a Metropolis-Hastings step. Given a proposal density $q(\rho^\ast\mid\rho)$, the acceptance probability is
\[
\alpha=\min\left\{1,\frac{p\bigl(\bm{r}\mid\sigma_r^2,\rho^\ast\bigr)p(\rho^\ast)q(\rho\mid\rho^\ast)}{p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr)p(\rho)q(\rho^\ast\mid\rho)}\right\}.
\]

\paragraph{Flexible Function $f(\cdot)$.} The function $f(\cdot)$ is updated using the Bayesian backfitting algorithm for SoftBART. In practice, the sum-of-trees representation
\[
f(X_{ij},Z_{ij},\hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij},Z_{ij},\hat{e}(X_{ij});T_h,M_h\Bigr)
\]
is updated sequentially over the $H$ trees, with tree structures $T_h$ and terminal node parameters $M_h$ being sampled from their conditional posterior distributions as described in \cite{chipman2010bart}.

\subsection{MCMC Sampling Algorithm}

We now describe the Metropolis-within-Gibbs procedure used to sample from the posterior distribution (\ref{eq:posterior}). A single iteration of the MCMC algorithm is summarized in Algorithm~\ref{alg:MCMC}.

\begin{algorithm}[H]
\caption{MCMC Sampling for the Spatial AFTSBART Model}\label{alg:MCMC}
\begin{algorithmic}[1]
\STATE \textbf{For each subject $(i,j)$ with $\delta_{ij}=0$:} Sample
\[
y_{ij}^\ast \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr)
\]
truncated to $(y_{ij},\infty)$.
\STATE \textbf{Update the function $f(\cdot)$:} Using the current values of $\{y_{ij}^\ast\}$ and $\{r_i\}$, update the SoftBART ensemble via the Bayesian backfitting algorithm.
\STATE \textbf{For each area $i=1,\ldots,I$:} Sample the spatial random effect $r_i$ from
\[
r_i\sim N\Bigl(\mu_{r_i},\,\tau_{r_i}^2\Bigr),
\]
with $\mu_{r_i}$ and $\tau_{r_i}^2$ as defined above.
\STATE \textbf{Update $\sigma^2$:} Sample from the full conditional distribution (\ref{eq:sigma2}).
\STATE \textbf{Update $\sigma_r^2$:} Sample from the full conditional distribution (\ref{eq:sigmar2}).
\STATE \textbf{Update $\rho$:} Propose a new value $\rho^\ast\sim q(\cdot\mid\rho)$ and accept it with probability
\[
\alpha=\min\left\{1,\frac{p\bigl(\bm{r}\mid\sigma_r^2,\rho^\ast\bigr)p(\rho^\ast)q(\rho\mid\rho^\ast)}{p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr)p(\rho)q(\rho^\ast\mid\rho)}\right\}.
\]
\STATE \textbf{Iterate:} Repeat steps 1--6 for a sufficiently large number of iterations to ensure convergence.
\end{algorithmic}
\end{algorithm}

Posterior samples of the model parameters are then used to compute causal effect estimates (e.g., contrasts in the predicted log survival times) after incorporating the estimated propensity scores $\hat{e}(X_{ij})$.

\vspace{0.5em}
\noindent \textbf{Note:} The two-step procedure entails first estimating the propensity scores via SBART and then treating $\hat{e}(X_{ij})$ as known when fitting the AFTSBART model. This approach facilitates flexible adjustment for confounding while capturing spatial heterogeneity in survival outcomes.

\medskip



\section{Model}

In this section we describe our Bayesian model for causal inference on spatially clustered survival data. Our approach proceeds in two stages. In the first stage we estimate the propensity score by regressing the binary treatment indicator on the covariates via a SBART model. The estimated propensity score, $\hat{e}(X_{ij})$, is then incorporated as an additional covariate in the survival outcome model. This two‐step procedure, analogous to double robustness in frequentist methods, protects against misspecification of either the treatment or outcome model. In the second stage we model the (log) survival times via an accelerated failure time (AFT) formulation with a flexible nonparametric function and spatial random effects.

\subsection{Model Specification}

We assume that for area $i=1,\ldots,I$ and subject $j=1,\ldots,n_i$ the true survival time $T_{ij}$ satisfies
\begin{equation} \label{eq:aftmodel}
\log T_{ij} = f\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij})\Bigr) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\end{equation}
where $X_{ij}$ is a vector of subject-specific covariates, $Z_{ij}$ is the binary treatment indicator, and $\hat{e}(X_{ij})$ is the propensity score obtained from a first-stage SBART regression of $Z_{ij}$ on $X_{ij}$. The function $f(\cdot)$ is modeled nonparametrically via SoftBART, representing the sum of a set of shallow regression trees with soft decision rules. The spatial random effect $r_i$ accounts for area-level heterogeneity and is assigned a conditional autoregressive (CAR) prior,
\begin{equation} \label{eq:carprior}
p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho)\vert^{1/2} \exp\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\},
\end{equation}
with $\bm{r}=(r_1,\ldots,r_I)^\top$ and precision matrix
\[
Q(\rho)=D-\rho\,W,
\]
where $W$ is the spatial adjacency matrix and $D$ is a diagonal matrix with entries $D_{ii}=\sum_jW_{ij}$. Right censoring is accommodated by observing
\[
T_{ij}^{\mathrm{obs}} = \min(T_{ij}, C_{ij}), \quad \delta_{ij}=I(T_{ij}\le C_{ij}),
\]
and working with the log-scale outcome $y_{ij}=\log T_{ij}^{\mathrm{obs}}$. For censored observations, latent variables $y_{ij}^\ast$ are introduced so that
\[
y_{ij}^\ast = \log T_{ij} = 
\begin{cases}
y_{ij}, & \delta_{ij}=1,\\[1mm]
\text{latent with } y_{ij}^\ast > y_{ij}, & \delta_{ij}=0.
\end{cases}
\]

Priors are assigned as follows. We take
\[
\sigma^2 \sim \mathrm{IG}(a_\sigma,b_\sigma),\quad \sigma_r^2 \sim \mathrm{IG}(a_r,b_r),
\]
and assume a uniform prior on the spatial dependence parameter $\rho$ over its admissible range. The flexible function $f(\cdot)$ is modeled via SoftBART with the usual regularizing priors on tree structures and terminal node parameters (see, e.g., \cite{chipman2010bart}).

\subsection{Posterior Inference and MCMC Algorithm}

Let $\theta=\{f(\cdot),\bm{r},\sigma^2,\sigma_r^2,\rho\}$ denote the collection of model parameters. The augmented likelihood for the complete (latent) data is
\begin{equation} \label{eq:posterior}
p\Bigl(\theta, \{y_{ij}^\ast\}_{\delta_{ij}=0}\mid \{y_{ij}\},X,Z\Bigr) \propto \prod_{i=1}^{I}\prod_{j=1}^{n_i} \phi\Bigl(y_{ij}^\ast; f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) I\{y_{ij}^\ast\in\mathcal{A}_{ij}\} \, p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr) \, p(\sigma^2)p(\sigma_r^2)p(\rho)p(f(\cdot)\bigr),
\end{equation}
where $\phi(\cdot;\mu,\sigma^2)$ is the normal density and $\mathcal{A}_{ij}=\{y_{ij}\}$ when $\delta_{ij}=1$ and $(y_{ij},\infty)$ when $\delta_{ij}=0$. The full conditional distributions are derived as follows.

For each censored observation ($\delta_{ij}=0$), the latent variable is updated by sampling from a truncated normal distribution:
\begin{equation} \label{eq:latent}
y_{ij}^\ast\mid \cdot \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) \quad \text{truncated to } (y_{ij},\infty).
\end{equation}
The spatial effects are updated via their full conditionals. For each area $i$, combining the likelihood and the CAR prior yields
\begin{equation} \label{eq:rfull}
r_i\mid \cdot \sim N\Biggl(\tau_{r_i}^2\Bigl\{\frac{1}{\sigma^2}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))\Bigr) -\frac{1}{\sigma_r^2}\sum_{k\neq i}Q_{ik}r_k\Bigr\},\ \tau_{r_i}^2\Biggr),
\end{equation}
with $\tau_{r_i}^2=(n_i/\sigma^2+Q_{ii}/\sigma_r^2)^{-1}$. The error variance $\sigma^2$ is updated from
\begin{equation} \label{eq:sigma2full}
\sigma^2\mid \cdot \sim \mathrm{IG}\Biggl(a_\sigma+\frac{N}{2},\, b_\sigma+\frac{1}{2}\sum_{i=1}^{I}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))-r_i\Bigr)^2\Biggr),
\end{equation}
where $N=\sum_{i=1}^I n_i$. Similarly, $\sigma_r^2$ is updated from
\begin{equation} \label{eq:sigmar2full}
\sigma_r^2\mid \cdot \sim \mathrm{IG}\Biggl(a_r+\frac{I}{2},\, b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\end{equation}
The spatial dependence parameter $\rho$ does not have a closed-form full conditional and is updated via a Metropolis--Hastings step with a suitable proposal density. Finally, the flexible function $f(\cdot)$ is updated using the Bayesian backfitting algorithm for SoftBART, wherein the sum-of-trees representation
\[
f(X_{ij},Z_{ij},\hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij},Z_{ij},\hat{e}(X_{ij});T_h,M_h\Bigr)
\]
is sequentially updated over the ensemble of $H$ trees.

A single iteration of the Metropolis-within-Gibbs sampling algorithm is summarized in Algorithm~\ref{alg:msamp}.

\begin{algorithm}[H]
\caption{MCMC Sampling Algorithm for the Spatial AFTSBART Model}\label{alg:msamp}
\begin{enumerate}
    \item For each censored observation $(i,j)$, update $y_{ij}^\ast$ according to (\ref{eq:latent}).
    \item Update the function $f(\cdot)$ using the current latent outcomes $\{y_{ij}^\ast\}$ and spatial effects $\{r_i\}$ via Bayesian backfitting for SoftBART.
    \item For $i=1,\ldots,I$, update the spatial random effect $r_i$ from (\ref{eq:rfull}).
    \item Update $\sigma^2$ from (\ref{eq:sigma2full}) and $\sigma_r^2$ from (\ref{eq:sigmar2full}).
    \item Update $\rho$ using a Metropolis--Hastings step.
    \item Repeat steps 1--5 for a sufficiently large number of iterations.
\end{enumerate}
\end{algorithm}

Posterior samples from the above algorithm are used to estimate causal effects as contrasts in the predicted log survival times. The two-stage procedure—whereby the estimated propensity score $\hat{e}(X_{ij})$ is included in the outcome model—achieves a form of double robustness analogous to frequentist methods, in that consistency may be maintained if either the treatment assignment or the outcome model is correctly specified.














\section{Methods}

\subsection{Notations}
Let \( i = 1, \ldots, n \) denote the cluster index, and \( j = 1, \ldots, N_i \) represent individuals within cluster \( i \). The treatment indicator for each individual is given by \( Z_{ij} \in \{0, 1\} \). The vector of covariates for individual \( j \) in cluster \( i \) is denoted by \( X_{ij} \). The propensity score for treatment assignment, defined as 
\[
e_{ij} = P(Z_{ij} = 1 \mid X_{ij}),
\]
is estimated using a non-parametric BART model. The true survival time and censoring time for each individual are represented as \( T_{ij} \) and \( C_{ij} \), respectively. The observed survival time is defined as 
\[
Y_{ij} = \min(T_{ij}, C_{ij}),
\]
and the censoring indicator is 
\[
\delta_{ij} = I(T_{ij} \leq C_{ij}).
\]
To evaluate the causal effects of treatment, we define potential (counterfactual) outcomes for survival and censoring times. Let \( T_{ij}(1) \) and \( T_{ij}(0) \) denote the potential survival times under treatment and control, respectively. Similarly, \( C_{ij}(1) \) and \( C_{ij}(0) \) denote the potential censoring times. Under the Stable Unit Treatment Value Assumption (SUTVA), the relationship between counterfactual and observed data is expressed as 
\[
T_{ij} = Z_{ij} T_{ij}(1) + (1 - Z_{ij}) T_{ij}(0)
\]
and 
\[
C_{ij} = Z_{ij} C_{ij}(1) + (1 - Z_{ij}) C_{ij}(0).
\]
Consequently, the observed survival time and censoring indicator are given by \( Y_{ij} = \min(T_{ij}, C_{ij}) \) and \( \delta_{ij} = I(T_{ij} \leq C_{ij}) \), respectively.

\subsection{Causal Estimands}
Causal estimands are defined to quantify the effect of treatment on survival outcomes. We consider several estimands, including the Survival Probability Causal Effect (SPCE), Average Causal Effect (ACE), and Restricted Average Causal Effect (RACE). These estimands provide different perspectives on the impact of treatment on survival and are described as follows.

The Survival Probability Causal Effect (SPCE) at time \( t \) is defined as the difference in survival probabilities between the treated and control groups. Mathematically, it is expressed as 
\[
\Delta \text{SPCE}(t) = S(1)(t) - S(0)(t), \quad \text{where} \quad S(z)(t) = P(T(z) \geq t)
\]
denotes the survival probability at time \( t \) under treatment \( z \). This estimand captures the absolute difference in survival probabilities at a specific time point, providing insight into the temporal effect of treatment on survival outcomes.

The Average Causal Effect (ACE) is defined as the difference in expected survival times between the treated and control groups:
\[
\Delta \text{ACE} = E[T(1)] - E[T(0)].
\]
This estimand provides a measure of the overall treatment effect on expected survival time, summarizing the average benefit or harm associated with treatment.

The Restricted Average Causal Effect (RACE) is defined as the difference in restricted mean survival times within a specified time window \( [0, t^*] \). It is represented as 
\[
\Delta \text{RACE} = E[\min(T(1), t^*)] - E[\min(T(0), t^*)].
\]
This estimand quantifies the treatment effect within a finite time horizon, providing a clinically interpretable measure of treatment benefit within a limited follow-up period.

Conditional counterparts of these estimands are also considered to account for individual heterogeneity and spatial dependencies. For example, the Conditional Survival Probability Causal Effect (CSPCE) at time \( t \) is defined as 
\[
\Delta \text{CSPCE}(t, X, W) = S(1)(t \mid X, W) - S(0)(t \mid X, W),
\]
and the Conditional Average Causal Effect (CACE) is given by 
\[
\Delta \text{CACE}(X, W) = E[T(1) \mid X, W] - E[T(0) \mid X, W].
\]
Similarly, the Conditional Restricted Average Causal Effect (CRACE) is defined as 
\[
\Delta \text{CRACE}(X, W) = E[\min(T(1), t^*) \mid X, W] - E[\min(T(0), t^*) \mid X, W].
\]

\subsection{Assumptions for Causal Inference}
Our methodological framework relies on several key assumptions to ensure valid causal inference. First, the Stable Unit Treatment Value Assumption (SUTVA) holds, meaning that each individual’s potential outcomes are well defined and that there is no interference between units. Specifically, we assume 
\[
T_{ij} = Z_{ij} T_{ij}(1) + (1 - Z_{ij}) T_{ij}(0) \quad \text{and} \quad C_{ij} = Z_{ij} C_{ij}(1) + (1 - Z_{ij}) C_{ij}(0).
\]
Second, the Ignorability Assumption asserts that the potential outcomes are independent of the treatment assignment given the observed covariates, i.e., 
\[
\{T(1), T(0)\} \perp Z \mid X.
\]
Third, the Overlap Assumption requires that every subject has a non-zero probability of receiving either treatment:
\[
0 < e(X) = P(Z = 1 \mid X) < 1.
\]
Finally, the Independent Censoring Assumption stipulates that survival times are independent of censoring times. In its strict form, we assume 
\[
T(z) \perp C(z),
\]
and in a conditional formulation, 
\[
T(z) \perp C(z) \mid X, Z=z,
\]
with possible extensions to allow for dependent censoring conditional on measured time-varying covariates.

\subsection{Model Specification}
Our approach proceeds in two stages. In the first stage, the propensity score is estimated by regressing the binary treatment indicator \( Z_{ij} \) on the covariates \( X_{ij} \) via a SBART model. The estimated propensity score, \(\hat{e}(X_{ij})\), is then incorporated as an additional covariate into the outcome model. This two‐step procedure—analogous to double robustness in frequentist causal inference—protects against misspecification of either the treatment or the outcome model.

In the second stage, the (log) survival times are modeled via an accelerated failure time (AFT) formulation that incorporates a flexible nonparametric function and spatial random effects. Specifically, for area \( i=1,\ldots,I \) and subject \( j=1,\ldots,n_i \), we assume
\[
\log T_{ij} = f\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij})\Bigr) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\]
where \( f(\cdot) \) is modeled via SoftBART as a sum-of-trees, and \( r_i \) denotes the spatial random effect for cluster \( i \). The spatial effects are modeled using a conditional autoregressive (CAR) prior,
\[
p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho)\vert^{1/2} \exp\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\},
\]
with the precision matrix defined as
\[
Q(\rho)=D-\rho\,W,
\]
where \( W \) is the spatial adjacency matrix and \( D \) is a diagonal matrix with \( D_{ii}=\sum_jW_{ij} \). Right censoring is handled by observing 
\[
T_{ij}^{\mathrm{obs}} = \min(T_{ij}, C_{ij}), \quad \delta_{ij} = I(T_{ij} \leq C_{ij}),
\]
and working with the log-scale outcome \( y_{ij}=\log T_{ij}^{\mathrm{obs}} \). For censored observations, latent variables \( y_{ij}^\ast \) are introduced such that
\[
y_{ij}^\ast = \log T_{ij} =
\begin{cases}
y_{ij}, & \delta_{ij}=1,\\[1mm]
\text{latent with } y_{ij}^\ast > y_{ij}, & \delta_{ij}=0.
\end{cases}
\]
Priors are specified as follows:
\[
\sigma^2 \sim \mathrm{IG}(a_\sigma,b_\sigma),\quad \sigma_r^2 \sim \mathrm{IG}(a_r,b_r),
\]
with a uniform prior on \(\rho\) over its admissible range, and standard regularizing priors on the tree structures and terminal node parameters of the SoftBART model (see, e.g., \cite{chipman2010bart}).

\subsection{Posterior Inference and MCMC Algorithm}
Let \(\theta=\{f(\cdot),\bm{r},\sigma^2,\sigma_r^2,\rho\}\) denote the collection of model parameters. The augmented likelihood for the complete (latent) data is given by
\[
p\Bigl(\theta, \{y_{ij}^\ast\}_{\delta_{ij}=0}\mid \{y_{ij}\},X,Z\Bigr) \propto \prod_{i=1}^{I}\prod_{j=1}^{n_i} \phi\Bigl(y_{ij}^\ast; f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) I\{y_{ij}^\ast\in\mathcal{A}_{ij}\} \, p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr) \, p(\sigma^2)\, p(\sigma_r^2)\, p(\rho)\, p(f(\cdot)\bigr),
\]
where \(\phi(\cdot;\mu,\sigma^2)\) is the normal density and 
\[
\mathcal{A}_{ij}=\begin{cases} \{y_{ij}\}, & \delta_{ij}=1, \\ (y_{ij},\infty), & \delta_{ij}=0. \end{cases}
\]

The full conditional updates are derived as follows. For each censored observation (\(\delta_{ij}=0\)), the latent variable \(y_{ij}^\ast\) is updated via a truncated normal distribution:
\[
y_{ij}^\ast\mid \cdot \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) \quad \text{truncated to } (y_{ij},\infty).
\]
The spatial effect \( r_i \) for each cluster is updated from
\[
r_i\mid \cdot \sim N\Biggl(\tau_{r_i}^2\Bigl\{\frac{1}{\sigma^2}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))\Bigr)-\frac{1}{\sigma_r^2}\sum_{k\neq i}Q_{ik}r_k\Bigr\},\, \tau_{r_i}^2\Biggr),
\]
with 
\[
\tau_{r_i}^2=\left(\frac{n_i}{\sigma^2}+\frac{Q_{ii}}{\sigma_r^2}\right)^{-1}.
\]
The error variance \(\sigma^2\) is updated from
\[
\sigma^2\mid \cdot \sim \mathrm{IG}\Biggl(a_\sigma+\frac{N}{2},\, b_\sigma+\frac{1}{2}\sum_{i=1}^{I}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))-r_i\Bigr)^2\Biggr),
\]
where \( N=\sum_{i=1}^I n_i \). Similarly, \(\sigma_r^2\) is updated from
\[
\sigma_r^2\mid \cdot \sim \mathrm{IG}\Biggl(a_r+\frac{I}{2},\, b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\]
The spatial dependence parameter \(\rho\) is updated via a Metropolis--Hastings step with a suitable proposal density. Finally, the function \( f(\cdot) \) is updated using the Bayesian backfitting algorithm for SoftBART, where the sum-of-trees representation
\[
f(X_{ij},Z_{ij},\hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij},Z_{ij},\hat{e}(X_{ij});T_h,M_h\Bigr)
\]
is sequentially updated over the ensemble of \( H \) trees.

A single iteration of the Metropolis-within-Gibbs sampling algorithm is summarized as follows:
\begin{enumerate}
    \item For each censored observation \((i,j)\), update \( y_{ij}^\ast \) as above.
    \item Update the function \( f(\cdot) \) using the current latent outcomes and spatial effects via Bayesian backfitting for SoftBART.
    \item For \( i=1,\ldots,I \), update the spatial random effect \( r_i \) from its full conditional.
    \item Update \(\sigma^2\) and \(\sigma_r^2\) from their respective full conditionals.
    \item Update \(\rho\) using a Metropolis--Hastings step.
    \item Repeat steps 1--5 for a sufficiently large number of iterations.
\end{enumerate}
Posterior samples obtained from the above algorithm are used to compute causal effect estimates as contrasts in the predicted log survival times.



\section{Model}

In this section we describe our Bayesian model for causal inference on spatially clustered survival data. Our approach proceeds in two stages. In the first stage we estimate the propensity score by regressing the binary treatment indicator on the covariates via a SBART model. The estimated propensity score, $\hat{e}(X_{ij})$, is then incorporated as an additional covariate in the survival outcome model. This two‐step procedure, analogous to double robustness in frequentist methods, protects against misspecification of either the treatment or outcome model. In the second stage we model the (log) survival times via an accelerated failure time (AFT) formulation with a flexible nonparametric function and spatial random effects.

\subsection{Model Specification}

We assume that for area $i=1,\ldots,I$ and subject $j=1,\ldots,n_i$ the true survival time $T_{ij}$ satisfies
\begin{equation} \label{eq:aftmodel}
\log T_{ij} = f\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij})\Bigr) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\end{equation}
where $X_{ij}$ is a vector of subject-specific covariates, $Z_{ij}$ is the binary treatment indicator, and $\hat{e}(X_{ij})$ is the propensity score obtained from a first-stage SBART regression of $Z_{ij}$ on $X_{ij}$. The function $f(\cdot)$ is modeled nonparametrically via SoftBART, representing the sum of a set of shallow regression trees with soft decision rules. The spatial random effect $r_i$ accounts for area-level heterogeneity and is assigned a conditional autoregressive (CAR) prior,
\begin{equation} \label{eq:carprior}
p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho)\vert^{1/2} \exp\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\},
\end{equation}
with $\bm{r}=(r_1,\ldots,r_I)^\top$ and precision matrix
\[
Q(\rho)=D-\rho\,W,
\]
where $W$ is the spatial adjacency matrix and $D$ is a diagonal matrix with entries $D_{ii}=\sum_jW_{ij}$. Right censoring is accommodated by observing
\[
T_{ij}^{\mathrm{obs}} = \min(T_{ij}, C_{ij}), \quad \delta_{ij}=I(T_{ij}\le C_{ij}),
\]
and working with the log-scale outcome $y_{ij}=\log T_{ij}^{\mathrm{obs}}$. For censored observations, latent variables $y_{ij}^\ast$ are introduced so that
\[
y_{ij}^\ast = \log T_{ij} = 
\begin{cases}
y_{ij}, & \delta_{ij}=1,\\[1mm]
\text{latent with } y_{ij}^\ast > y_{ij}, & \delta_{ij}=0.
\end{cases}
\]

Priors are assigned as follows. We take
\[
\sigma^2 \sim \mathrm{IG}(a_\sigma,b_\sigma),\quad \sigma_r^2 \sim \mathrm{IG}(a_r,b_r),
\]
and assume a uniform prior on the spatial dependence parameter $\rho$ over its admissible range. The flexible function $f(\cdot)$ is modeled via SoftBART with the usual regularizing priors on tree structures and terminal node parameters (see, e.g., \cite{chipman2010bart}).

\subsection{Posterior Inference and MCMC Algorithm}

Let $\theta=\{f(\cdot),\bm{r},\sigma^2,\sigma_r^2,\rho\}$ denote the collection of model parameters. The augmented likelihood for the complete (latent) data is
\begin{equation} \label{eq:posterior}
p\Bigl(\theta, \{y_{ij}^\ast\}_{\delta_{ij}=0}\mid \{y_{ij}\},X,Z\Bigr) \propto \prod_{i=1}^{I}\prod_{j=1}^{n_i} \phi\Bigl(y_{ij}^\ast; f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) I\{y_{ij}^\ast\in\mathcal{A}_{ij}\} \, p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr) \, p(\sigma^2)p(\sigma_r^2)p(\rho)p(f(\cdot)\bigr),
\end{equation}
where $\phi(\cdot;\mu,\sigma^2)$ is the normal density and $\mathcal{A}_{ij}=\{y_{ij}\}$ when $\delta_{ij}=1$ and $(y_{ij},\infty)$ when $\delta_{ij}=0$. The full conditional distributions are derived as follows.

For each censored observation ($\delta_{ij}=0$), the latent variable is updated by sampling from a truncated normal distribution:
\begin{equation} \label{eq:latent}
y_{ij}^\ast\mid \cdot \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) \quad \text{truncated to } (y_{ij},\infty).
\end{equation}
The spatial effects are updated via their full conditionals. For each area $i$, combining the likelihood and the CAR prior yields
\begin{equation} \label{eq:rfull}
r_i\mid \cdot \sim N\Biggl(\tau_{r_i}^2\Bigl\{\frac{1}{\sigma^2}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))\Bigr) -\frac{1}{\sigma_r^2}\sum_{k\neq i}Q_{ik}r_k\Bigr\},\ \tau_{r_i}^2\Biggr),
\end{equation}
with $\tau_{r_i}^2=(n_i/\sigma^2+Q_{ii}/\sigma_r^2)^{-1}$. The error variance $\sigma^2$ is updated from
\begin{equation} \label{eq:sigma2full}
\sigma^2\mid \cdot \sim \mathrm{IG}\Biggl(a_\sigma+\frac{N}{2},\, b_\sigma+\frac{1}{2}\sum_{i=1}^{I}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))-r_i\Bigr)^2\Biggr),
\end{equation}
where $N=\sum_{i=1}^I n_i$. Similarly, $\sigma_r^2$ is updated from
\begin{equation} \label{eq:sigmar2full}
\sigma_r^2\mid \cdot \sim \mathrm{IG}\Biggl(a_r+\frac{I}{2},\, b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\end{equation}
The spatial dependence parameter $\rho$ does not have a closed-form full conditional and is updated via a Metropolis--Hastings step with a suitable proposal density. Finally, the flexible function $f(\cdot)$ is updated using the Bayesian backfitting algorithm for SoftBART, wherein the sum-of-trees representation
\[
f(X_{ij},Z_{ij},\hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij},Z_{ij},\hat{e}(X_{ij});T_h,M_h\Bigr)
\]
is sequentially updated over the ensemble of $H$ trees.

A single iteration of the Metropolis-within-Gibbs sampling algorithm is summarized in Algorithm~\ref{alg:msamp}.

\begin{algorithm}[H]
\caption{MCMC Sampling Algorithm for the Spatial AFTSBART Model}\label{alg:msamp}
\begin{enumerate}
    \item For each censored observation $(i,j)$, update $y_{ij}^\ast$ according to (\ref{eq:latent}).
    \item Update the function $f(\cdot)$ using the current latent outcomes $\{y_{ij}^\ast\}$ and spatial effects $\{r_i\}$ via Bayesian backfitting for SoftBART.
    \item For $i=1,\ldots,I$, update the spatial random effect $r_i$ from (\ref{eq:rfull}).
    \item Update $\sigma^2$ from (\ref{eq:sigma2full}) and $\sigma_r^2$ from (\ref{eq:sigmar2full}).
    \item Update $\rho$ using a Metropolis--Hastings step.
    \item Repeat steps 1--5 for a sufficiently large number of iterations.
\end{enumerate}
\end{algorithm}

Posterior samples from the above algorithm are used to estimate causal effects as contrasts in the predicted log survival times. The two-stage procedure—whereby the estimated propensity score $\hat{e}(X_{ij})$ is included in the outcome model—achieves a form of double robustness analogous to frequentist methods, in that consistency may be maintained if either the treatment assignment or the outcome model is correctly specified.






\section{Methods}

This section presents a detailed description of the methodological framework used for estimating causal effects in spatially clustered survival data. Our approach leverages Soft Bayesian Additive Regression Trees (SBART) to model complex relationships between covariates and outcomes, and a Conditional Auto-Regressive (CAR) model to account for spatial dependencies. Additionally, observational studies incorporate a propensity score model to adjust for confounding. 

\subsection{Notations}
Let \( i = 1, \ldots, n \) denote the cluster index, and \( j = 1, \ldots, N_i \) represent individuals within cluster \( i \). The treatment indicator for each individual is given by \( Z_{ij} \in \{0, 1\} \). The vector of covariates for individual \( j \) in cluster \( i \) is denoted by \( X_{ij} \). The propensity score for treatment assignment, defined as \( e_{ij} = P(Z_{ij} = 1 \mid X_{ij}) \), is estimated using a non-parametric BART model. The true survival time and censoring time for each individual are represented as \( T_{ij} \) and \( C_{ij} \), respectively. The observed survival time is defined as \( Y_{ij} = \min(T_{ij}, C_{ij}) \), and the censoring indicator is \( \delta_{ij} = I(T_{ij} \leq C_{ij})\).

To evaluate the causal effects of treatment, we define potential (counterfactual) outcomes for survival and censoring times. Let \( T_{ij}(1) \) and \( T_{ij}(0) \) denote the potential survival times under treatment and control, respectively. Similarly, \( C_{ij}(1) \) and \( C_{ij}(0) \) denote the potential censoring times. Under the Stable Unit Treatment Value Assumption (SUTVA), the relationship between counterfactual and observed data is expressed as 
\[
T_{ij} = Z_{ij} T_{ij}(1) + (1 - Z_{ij}) T_{ij}(0)
\]
and 
\[
C_{ij} = Z_{ij} C_{ij}(1) + (1 - Z_{ij}) C_{ij}(0).
\]
Consequently, the observed survival time and censoring indicator are given by 
\[
Y_{ij} = \min(T_{ij}, C_{ij}) \quad \text{and} \quad \delta_{ij} = I(T_{ij} \leq C_{ij}).
\]

\subsection{Causal Estimands}

Causal estimands are defined to quantify the effect of treatment on survival outcomes. We consider several estimands, including the Survival Probability Causal Effect (SPCE), Average Causal Effect (ACE), and Restricted Average Causal Effect (RACE). These estimands provide different perspectives on the impact of treatment on survival and are described as follows.

The Survival Probability Causal Effect (SPCE) at time \( t \) is defined as the difference in survival probabilities between the treated and control groups. Mathematically, it is expressed as 
\[
\Delta \text{SPCE}(t) = S(1)(t) - S(0)(t), \quad \textit{where} \quad S(z)(t) = P(T(z) \geq t)
\]
represents the survival probability at time \( t \) under treatment \( z \). This estimand captures the absolute difference in survival probabilities at a specific time point, providing insight into the temporal effect of treatment on survival outcomes.

The Average Causal Effect (ACE) is defined as the difference in expected survival times between the treated and control groups. It is expressed as 
\[
\Delta \text{ACE} = E[T(1)] - E[T(0)].
\]
This estimand provides a measure of the overall treatment effect on expected survival time, summarizing the average benefit or harm associated with treatment.

The Restricted Average Causal Effect (RACE) is defined as the difference in restricted mean survival times within a specified time window \( [0, t^*] \). It is represented as 
\[
\Delta \text{RACE} = E[\min(T(1), t^*)] - E[\min(T(0), t^*)].
\]
This estimand quantifies the treatment effect within a finite time horizon, providing a clinically interpretable measure of treatment benefit within a limited follow-up period.

We also consider conditional counterparts of these estimands to account for individual heterogeneity and spatial dependencies. The Conditional Survival Probability Causal Effect (CSPCE) at time \( t \) is defined as the difference in survival probabilities, conditional on covariates \( X \) and spatial random effects \( W \). It is given by 
\[
\Delta \text{CSPCE}(t, X, W) = S(1)(t \mid X, W) - S(0)(t \mid X, W).
\]
The Conditional Average Causal Effect (CACE) represents the difference in expected survival times, conditional on covariates \( X \) and spatial random effects \( W \):
\[
\Delta \text{CACE}(X, W) = E[T(1) \mid X, W] - E[T(0) \mid X, W].
\]
Similarly, the Conditional Restricted Average Causal Effect (CRACE) is defined as the difference in restricted mean survival times within a specified time window \( [0, t^*] \), conditional on \( X \) and \( W \):
\[
\Delta \text{CRACE}(X, W) = E[\min(T(1), t^*) \mid X, W] - E[\min(T(0), t^*) \mid X, W].
\]

\subsection{Assumptions for Causal Inference}

The methodological framework relies on several key assumptions for valid causal inference. 
\begin{itemize}
   \item The \textbf{Stable Unit Treatment Value Assumption (SUTVA)}: The relationship between counterfactual and observed data is expressed as 
   \[
   T_{ij} = Z_{ij} T_{ij}(1) + (1 - Z_{ij}) T_{ij}(0)
   \]
   and 
   \[
   C_{ij} = Z_{ij} C_{ij}(1) + (1 - Z_{ij}) C_{ij}(0).
   \]
   \item The \textbf{Ignorability Assumption} states that potential outcomes are independent of treatment assignment given covariates: 
   \[
   \{T(1), T(0)\} \perp Z \mid X.
   \]
   \item The \textbf{Overlap Assumption} ensures that each subject has a non-zero probability of receiving either treatment: 
   \[
   0 < e(X) = P(Z = 1 \mid X) < 1.
   \]
   \item The \textbf{Independent Censoring Assumption} implies that survival times are independent of censoring times, i.e., 
   \[
   T(z) \perp C(z).
   \]
   This assumption can be relaxed to allow for conditionally independent censoring given covariates and treatment assignment, \( T(z) \perp C(z) \mid X, Z = z \), or further extended to model dependent censoring conditional on measured time-varying covariates.
\end{itemize}  

\subsection{Model Specification}

Our approach proceeds in two stages. In the first stage, the propensity score is estimated by regressing the binary treatment indicator \( Z_{ij} \) on the covariates \( X_{ij} \) via a SBART model. The estimated propensity score, \(\hat{e}(X_{ij})\), is then incorporated as an additional covariate into the outcome model. This two‐step procedure—analogous to double robustness in frequentist causal inference—protects against misspecification of either the treatment or the outcome model.

In the second stage, the (log) survival times are modeled via an accelerated failure time (AFT) formulation that incorporates a flexible nonparametric function and spatial random effects. For area \( i=1,\ldots,I \) and subject \( j=1,\ldots,n_i \), we assume
\begin{equation} \label{eq:aftmodel}
\log T_{ij} = f\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij})\Bigr) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\end{equation}
where \(X_{ij}\) is a vector of subject-specific covariates, \(Z_{ij}\) is the binary treatment indicator, and \(\hat{e}(X_{ij})\) is the propensity score obtained from a first-stage SBART regression of \(Z_{ij}\) on \(X_{ij}\). The function \(f(\cdot)\) is modeled nonparametrically via SoftBART, representing the sum of a set of shallow regression trees with soft decision rules. The spatial random effect \(r_i\) accounts for area-level heterogeneity and is assigned a conditional autoregressive (CAR) prior,
\begin{equation} \label{eq:carprior}
p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho)\vert^{1/2} \exp\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\},
\end{equation}
with \(\bm{r}=(r_1,\ldots,r_I)^\top\) and precision matrix
\[
Q(\rho)=D-\rho\,W,
\]
where \(W\) is the spatial adjacency matrix and \(D\) is a diagonal matrix with entries \(D_{ii}=\sum_jW_{ij}\). Right censoring is accommodated by observing
\[
T_{ij}^{\mathrm{obs}} = \min(T_{ij}, C_{ij}), \quad \delta_{ij}=I(T_{ij}\le C_{ij}),
\]
and working with the log-scale outcome \(y_{ij}=\log T_{ij}^{\mathrm{obs}}\). For censored observations, latent variables \(y_{ij}^\ast\) are introduced so that
\[
y_{ij}^\ast = \log T_{ij} = 
\begin{cases}
y_{ij}, & \delta_{ij}=1,\\[1mm]
\text{latent with } y_{ij}^\ast > y_{ij}, & \delta_{ij}=0.
\end{cases}
\]

Priors are assigned as follows. We take
\[
\sigma^2 \sim \mathrm{IG}(a_\sigma,b_\sigma),\quad \sigma_r^2 \sim \mathrm{IG}(a_r,b_r),
\]
and assume a uniform prior on the spatial dependence parameter \(\rho\) over its admissible range. The flexible function \(f(\cdot)\) is modeled via SoftBART with the usual regularizing priors on tree structures and terminal node parameters (see, e.g., \cite{Chipman10}).

\subsection{Posterior Inference and MCMC Algorithm}

Let \(\theta=\{f(\cdot),\bm{r},\sigma^2,\sigma_r^2,\rho\}\) denote the collection of model parameters. The augmented likelihood for the complete (latent) data is
\begin{equation} \label{eq:posterior}
p\Bigl(\theta, \{y_{ij}^\ast\}_{\delta_{ij}=0}\mid \{y_{ij}\},X,Z\Bigr) \propto \prod_{i=1}^{I}\prod_{j=1}^{n_i} \phi\Bigl(y_{ij}^\ast; f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) I\{y_{ij}^\ast\in\mathcal{A}_{ij}\} \, p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr) \, p(\sigma^2)p(\sigma_r^2)p(\rho)p(f(\cdot)\bigr),
\end{equation}
where \(\phi(\cdot;\mu,\sigma^2)\) is the normal density and \(\mathcal{A}_{ij}=\{y_{ij}\}\) when \(\delta_{ij}=1\) and \((y_{ij},\infty)\) when \(\delta_{ij}=0\). The full conditional distributions are derived as follows.

For each censored observation (\(\delta_{ij}=0\)), the latent variable is updated by sampling from a truncated normal distribution:
\begin{equation} \label{eq:latent}
y_{ij}^\ast\mid \cdot \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) \quad \text{truncated to } (y_{ij},\infty).
\end{equation}
The spatial effects are updated via their full conditionals. For each area \(i\), combining the likelihood and the CAR prior yields
\begin{equation} \label{eq:rfull}
r_i\mid \cdot \sim N\Biggl(\tau_{r_i}^2\Bigl\{\frac{1}{\sigma^2}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))\Bigr) -\frac{1}{\sigma_r^2}\sum_{k\neq i}Q_{ik}r_k\Bigr\},\ \tau_{r_i}^2\Biggr),
\end{equation}
with \(\tau_{r_i}^2=(n_i/\sigma^2+Q_{ii}/\sigma_r^2)^{-1}\). The error variance \(\sigma^2\) is updated from
\begin{equation} \label{eq:sigma2full}
\sigma^2\mid \cdot \sim \mathrm{IG}\Biggl(a_\sigma+\frac{N}{2},\, b_\sigma+\frac{1}{2}\sum_{i=1}^{I}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))-r_i\Bigr)^2\Biggr),
\end{equation}
where \(N=\sum_{i=1}^I n_i\). Similarly, \(\sigma_r^2\) is updated from
\begin{equation} \label{eq:sigmar2full}
\sigma_r^2\mid \cdot \sim \mathrm{IG}\Biggl(a_r+\frac{I}{2},\, b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\end{equation}
The spatial dependence parameter \(\rho\) does not have a closed-form full conditional and is updated via a Metropolis--Hastings step with a suitable proposal density. Finally, the flexible function \(f(\cdot)\) is updated using the Bayesian backfitting algorithm for SoftBART, wherein the sum-of-trees representation
\[
f(X_{ij},Z_{ij},\hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij},Z_{ij},\hat{e}(X_{ij});T_h,M_h\Bigr)
\]
is sequentially updated over the ensemble of \(H\) trees.

A single iteration of the Metropolis-within-Gibbs sampling algorithm is summarized in Algorithm~\ref{alg:msamp}.

\begin{algorithm}[H]
\caption{MCMC Sampling Algorithm for the Spatial AFTSBART Model}\label{alg:msamp}
\begin{enumerate}
    \item For each censored observation \((i,j)\), update \(y_{ij}^\ast\) according to (\ref{eq:latent}).
    \item Update the function \(f(\cdot)\) using the current latent outcomes \(\{y_{ij}^\ast\}\) and spatial effects \(\{r_i\}\) via Bayesian backfitting for SoftBART.
    \item For \(i=1,\ldots,I\), update the spatial random effect \(r_i\) from (\ref{eq:rfull}).
    \item Update \(\sigma^2\) from (\ref{eq:sigma2full}) and \(\sigma_r^2\) from (\ref{eq:sigmar2full}).
    \item Update \(\rho\) using a Metropolis--Hastings step.
\end{enumerate}
\end{algorithm}

Posterior samples from the above algorithm are used to estimate causal effects as contrasts in the predicted log survival times. The two-stage procedure—whereby the estimated propensity score \(\hat{e}(X_{ij})\) is included in the outcome model—achieves a form of double robustness analogous to frequentist methods, in that consistency may be maintained if either the treatment assignment or the outcome model is correctly specified.

\subsection{Posterior Inference for Causal Estimands}

Let \(\theta^{(s)} = \{f^{(s)}(\cdot), r^{(s)}, \sigma^{(s)}\}\) denote the \(s\)th posterior draw from the model. For an individual with covariates \(X\) and spatial effect \(W\) (with \(W\) typically represented by the corresponding area effect \(r\)), the predictive distribution for \(\log T(z)\) under treatment \(z \in \{0,1\}\) is
\[
\log T(z) \mid X, W, \theta^{(s)} \sim N\Bigl(\mu_z^{(s)}, \bigl(\sigma^{(s)}\bigr)^2\Bigr),
\]
with
\[
\mu_z^{(s)} = f^{(s)}\Bigl(X, z, \hat{e}(X)\Bigr) + r^{(s)}.
\]

The corresponding survival function at time \(t\) is given by
\[
S^{(s)}(z)(t\mid X,W) = P\Bigl(T(z) \ge t \mid X,W,\theta^{(s)}\Bigr) = 1 - \Phi\Biggl(\frac{\log t - \mu_z^{(s)}}{\sigma^{(s)}}\Biggr),
\]
where \(\Phi(\cdot)\) denotes the standard normal cumulative distribution function.

\paragraph{Conditional Survival Probability Causal Effect (CSPCE):}  
For a fixed time \(t\), the CSPCE for the \(s\)th draw is computed as
\[
\Delta \text{CSPCE}^{(s)}(t, X, W) = S^{(s)}(1)(t\mid X,W) - S^{(s)}(0)(t\mid X,W),
\]
or explicitly,
\[
\Delta \text{CSPCE}^{(s)}(t, X, W) = \Phi\Biggl(\frac{\log t - f^{(s)}\bigl(X,0,\hat{e}(X)\bigr) - r^{(s)}}{\sigma^{(s)}}\Biggr) - \Phi\Biggl(\frac{\log t - f^{(s)}\bigl(X,1,\hat{e}(X)\bigr) - r^{(s)}}{\sigma^{(s)}}\Biggr).
\]

\paragraph{Conditional Average Causal Effect (CACE):}  
Exploiting the log-normality of \(T(z)\), the conditional expected survival time under treatment \(z\) is
\[
E\Bigl[T(z) \mid X,W,\theta^{(s)}\Bigr] = \exp\Bigl\{ f^{(s)}\bigl(X,z,\hat{e}(X)\bigr) + r^{(s)} + \frac{\bigl(\sigma^{(s)}\bigr)^2}{2} \Bigr\}.
\]
Thus, the \(s\)th posterior draw for the CACE is given by
\[
\Delta \text{CACE}^{(s)}(X, W) = \exp\Bigl\{ f^{(s)}\bigl(X,1,\hat{e}(X)\bigr) + r^{(s)} + \frac{\bigl(\sigma^{(s)}\bigr)^2}{2} \Bigr\} - \exp\Bigl\{ f^{(s)}\bigl(X,0,\hat{e}(X)\bigr) + r^{(s)} + \frac{\bigl(\sigma^{(s)}\bigr)^2}{2} \Bigr\}.
\]

\paragraph{Conditional Restricted Average Causal Effect (CRACE):}  
The conditional restricted mean survival time under treatment \(z\) for a time horizon \(t^*\) is defined as
\[
E\Bigl[\min\bigl(T(z),t^*\bigr) \mid X,W,\theta^{(s)}\Bigr] = \int_{0}^{t^*} S^{(s)}(z)(t\mid X,W) \, dt.
\]
Therefore, the CRACE for the \(s\)th draw is
\[
\Delta \text{CRACE}^{(s)}(X, W) = \int_{0}^{t^*} \Bigl\{ S^{(s)}(1)(t\mid X,W) - S^{(s)}(0)(t\mid X,W) \Bigr\} dt.
\]
In practice, this integral can be approximated numerically (e.g., using Simpson's rule or Riemann sums).

Posterior inference on the estimands is then carried out by computing these quantities for each posterior draw \(s=1,\ldots,S\) and summarizing the resulting empirical distribution (e.g., via posterior means, credible intervals, etc.).
















\section{Methods}

This section presents a detailed description of the methodological framework used for estimating causal effects in spatially clustered survival data. Our approach leverages Soft Bayesian Additive Regression Trees (SBART) to model complex relationships between covariates and outcomes, and a Conditional Auto-Regressive (CAR) model to account for spatial dependencies. Additionally, observational studies incorporate a propensity score model to adjust for confounding. 

\subsection{Notations}
Let \( i = 1, \ldots, n \) denote the cluster index, and \( j = 1, \ldots, N_i \) represent individuals within cluster \( i \). The treatment indicator for each individual is given by \( Z_{ij} \in \{0, 1\} \). The vector of covariates for individual \( j \) in cluster \( i \) is denoted by \( X_{ij} \). The propensity score for treatment assignment, defined as \( e_{ij} = P(Z_{ij} = 1 \mid X_{ij}) \), is estimated using a non-parametric BART model. The true survival time and censoring time for each individual are represented as \( T_{ij} \) and \( C_{ij} \), respectively. The observed survival time is defined as \( Y_{ij} = \min(T_{ij}, C_{ij}) \), and the censoring indicator is \( \delta_{ij} = I(T_{ij} \leq C_{ij})\).

To evaluate the causal effects of treatment, we define potential (counterfactual) outcomes for survival and censoring times. Let \( T_{ij}(1) \) and \( T_{ij}(0) \) denote the potential survival times under treatment and control, respectively. Similarly, \( C_{ij}(1) \) and \( C_{ij}(0) \) denote the potential censoring times. Under the Stable Unit Treatment Value Assumption (SUTVA), the relationship between counterfactual and observed data is expressed as 
\[
T_{ij} = Z_{ij} T_{ij}(1) + (1 - Z_{ij}) T_{ij}(0)
\]
and 
\[
C_{ij} = Z_{ij} C_{ij}(1) + (1 - Z_{ij}) C_{ij}(0).
\]
Consequently, the observed survival time and censoring indicator are given by 
\[
Y_{ij} = \min(T_{ij}, C_{ij}) \quad \text{and} \quad \delta_{ij} = I(T_{ij} \leq C_{ij}).
\]

\subsection{Causal Estimands}

Causal estimands are defined to quantify the effect of treatment on survival outcomes. We consider several estimands, including the Survival Probability Causal Effect (SPCE), Average Causal Effect (ACE), and Restricted Average Causal Effect (RACE). These estimands provide different perspectives on the impact of treatment on survival and are described as follows.

The Survival Probability Causal Effect (SPCE) at time \( t \) is defined as the difference in survival probabilities between the treated and control groups. Mathematically, it is expressed as 
\[
\Delta \text{SPCE}(t) = S(1)(t) - S(0)(t), \quad \textit{where} \quad S(z)(t) = P(T(z) \geq t)
\]
represents the survival probability at time \( t \) under treatment \( z \). This estimand captures the absolute difference in survival probabilities at a specific time point, providing insight into the temporal effect of treatment on survival outcomes.

The Average Causal Effect (ACE) is defined as the difference in expected survival times between the treated and control groups. It is expressed as 
\[
\Delta \text{ACE} = E[T(1)] - E[T(0)].
\]
This estimand provides a measure of the overall treatment effect on expected survival time, summarizing the average benefit or harm associated with treatment.

The Restricted Average Causal Effect (RACE) is defined as the difference in restricted mean survival times within a specified time window \( [0, t^*] \). It is represented as 
\[
\Delta \text{RACE} = E[\min(T(1), t^*)] - E[\min(T(0), t^*)].
\]
This estimand quantifies the treatment effect within a finite time horizon, providing a clinically interpretable measure of treatment benefit within a limited follow-up period.

We also consider conditional counterparts of these estimands to account for individual heterogeneity and spatial dependencies. The Conditional Survival Probability Causal Effect (CSPCE) at time \( t \) is defined as the difference in survival probabilities, conditional on covariates \( X \) and spatial random effects \(\bm{r}\). It is given by 
\[
\Delta \text{CSPCE}(t, X, \bm{r}) = S(1)(t \mid X, \bm{r}) - S(0)(t \mid X, \bm{r}).
\]
The Conditional Average Causal Effect (CACE) represents the difference in expected survival times, conditional on covariates \( X \) and spatial random effects \(\bm{r}\):
\[
\Delta \text{CACE}(X, \bm{r}) = E[T(1) \mid X, \bm{r}] - E[T(0) \mid X, \bm{r}].
\]
Similarly, the Conditional Restricted Average Causal Effect (CRACE) is defined as the difference in restricted mean survival times within a specified time window \( [0, t^*] \), conditional on \( X \) and \(\bm{r}\):
\[
\Delta \text{CRACE}(X, \bm{r}) = E[\min(T(1), t^*) \mid X, \bm{r}] - E[\min(T(0), t^*) \mid X, \bm{r}].
\]

\subsection{Assumptions for Causal Inference}

The methodological framework relies on several key assumptions for valid causal inference. 
\begin{itemize}
   \item The \textbf{Stable Unit Treatment Value Assumption (SUTVA)}: The relationship between counterfactual and observed data is expressed as 
   \[
   T_{ij} = Z_{ij} T_{ij}(1) + (1 - Z_{ij}) T_{ij}(0)
   \]
   and 
   \[
   C_{ij} = Z_{ij} C_{ij}(1) + (1 - Z_{ij}) C_{ij}(0).
   \]
   \item The \textbf{Ignorability Assumption} states that potential outcomes are independent of treatment assignment given covariates: 
   \[
   \{T(1), T(0)\} \perp Z \mid X.
   \]
   \item The \textbf{Overlap Assumption} ensures that each subject has a non-zero probability of receiving either treatment: 
   \[
   0 < e(X) = P(Z = 1 \mid X) < 1.
   \]
   \item The \textbf{Independent Censoring Assumption} implies that survival times are independent of censoring times, i.e., 
   \[
   T(z) \perp C(z).
   \]
   This assumption can be relaxed to allow for conditionally independent censoring given covariates and treatment assignment, \( T(z) \perp C(z) \mid X, Z = z \), or further extended to model dependent censoring conditional on measured time-varying covariates.
\end{itemize}  

\subsection{Model Specification}

Our approach proceeds in two stages. In the first stage, the propensity score is estimated by regressing the binary treatment indicator \( Z_{ij} \) on the covariates \( X_{ij} \) via a SBART model. The estimated propensity score, \(\hat{e}(X_{ij})\), is then incorporated as an additional covariate into the outcome model. This two‐step procedure—analogous to double robustness in frequentist causal inference—protects against misspecification of either the treatment or the outcome model.

In the second stage, the (log) survival times are modeled via an accelerated failure time (AFT) formulation that incorporates a flexible nonparametric function and spatial random effects. For area \( i=1,\ldots,I \) and subject \( j=1,\ldots,n_i \), we assume
\begin{equation} \label{eq:aftmodel}
\log T_{ij} = f\Bigl(X_{ij}, Z_{ij}, \hat{e}(X_{ij})\Bigr) + r_i + \varepsilon_{ij}, \quad \varepsilon_{ij}\sim N(0,\sigma^2),
\end{equation}
where \(X_{ij}\) is a vector of subject-specific covariates, \(Z_{ij}\) is the binary treatment indicator, and \(\hat{e}(X_{ij})\) is the propensity score obtained from a first-stage SBART regression of \(Z_{ij}\) on \(X_{ij}\). The function \(f(\cdot)\) is modeled nonparametrically via SoftBART, representing the sum of a set of shallow regression trees with soft decision rules. The spatial random effect \(r_i\) accounts for area-level heterogeneity and is assigned a conditional autoregressive (CAR) prior,
\begin{equation} \label{eq:carprior}
p(\bm{r}\mid\sigma_r^2,\rho) \propto \vert Q(\rho)\vert^{1/2} \exp\Biggl\{-\frac{1}{2\sigma_r^2}\bm{r}^\top Q(\rho)\bm{r}\Biggr\},
\end{equation}
with \(\bm{r}=(r_1,\ldots,r_I)^\top\) and precision matrix
\[
Q(\rho)=D-\rho\,W,
\]
where \(W\) is the spatial adjacency matrix and \(D\) is a diagonal matrix with entries \(D_{ii}=\sum_jW_{ij}\). Right censoring is accommodated by observing
\[
T_{ij}^{\mathrm{obs}} = \min(T_{ij}, C_{ij}), \quad \delta_{ij}=I(T_{ij}\le C_{ij}),
\]
and working with the log-scale outcome \(y_{ij}=\log T_{ij}^{\mathrm{obs}}\). For censored observations, latent variables \(y_{ij}^\ast\) are introduced so that
\[
y_{ij}^\ast = \log T_{ij} = 
\begin{cases}
y_{ij}, & \delta_{ij}=1,\\[1mm]
\text{latent with } y_{ij}^\ast > y_{ij}, & \delta_{ij}=0.
\end{cases}
\]

Priors are assigned as follows. We take
\[
\sigma^2 \sim \mathrm{IG}(a_\sigma,b_\sigma),\quad \sigma_r^2 \sim \mathrm{IG}(a_r,b_r),
\]
and assume a uniform prior on the spatial dependence parameter \(\rho\) over its admissible range. The flexible function \(f(\cdot)\) is modeled via SoftBART with the usual regularizing priors on tree structures and terminal node parameters (see, e.g., \cite{Chipman10}).

\subsection{Posterior Inference and MCMC Algorithm}

Let \(\theta=\{f(\cdot),\bm{r},\sigma^2,\sigma_r^2,\rho\}\) denote the collection of model parameters. The augmented likelihood for the complete (latent) data is
\begin{equation} \label{eq:posterior}
p\Bigl(\theta, \{y_{ij}^\ast\}_{\delta_{ij}=0}\mid \{y_{ij}\},X,Z\Bigr) \propto \prod_{i=1}^{I}\prod_{j=1}^{n_i} \phi\Bigl(y_{ij}^\ast; f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) I\{y_{ij}^\ast\in\mathcal{A}_{ij}\} \, p\bigl(\bm{r}\mid\sigma_r^2,\rho\bigr) \, p(\sigma^2)p(\sigma_r^2)p(\rho)p(f(\cdot)\bigr),
\end{equation}
where \(\phi(\cdot;\mu,\sigma^2)\) is the normal density and \(\mathcal{A}_{ij}=\{y_{ij}\}\) when \(\delta_{ij}=1\) and \((y_{ij},\infty)\) when \(\delta_{ij}=0\). The full conditional distributions are derived as follows.

For each censored observation (\(\delta_{ij}=0\)), the latent variable is updated by sampling from a truncated normal distribution:
\begin{equation} \label{eq:latent}
y_{ij}^\ast\mid \cdot \sim N\Bigl(f(X_{ij},Z_{ij},\hat{e}(X_{ij}))+r_i,\sigma^2\Bigr) \quad \text{truncated to } (y_{ij},\infty).
\end{equation}
The spatial effects are updated via their full conditionals. For each area \(i\), combining the likelihood and the CAR prior yields
\begin{equation} \label{eq:rfull}
r_i\mid \cdot \sim N\Biggl(\tau_{r_i}^2\Bigl\{\frac{1}{\sigma^2}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))\Bigr) -\frac{1}{\sigma_r^2}\sum_{k\neq i}Q_{ik}r_k\Bigr\},\ \tau_{r_i}^2\Biggr),
\end{equation}
with \(\tau_{r_i}^2=(n_i/\sigma^2+Q_{ii}/\sigma_r^2)^{-1}\). The error variance \(\sigma^2\) is updated from
\begin{equation} \label{eq:sigma2full}
\sigma^2\mid \cdot \sim \mathrm{IG}\Biggl(a_\sigma+\frac{N}{2},\, b_\sigma+\frac{1}{2}\sum_{i=1}^{I}\sum_{j=1}^{n_i}\Bigl(y_{ij}^\ast-f(X_{ij},Z_{ij},\hat{e}(X_{ij}))-r_i\Bigr)^2\Biggr),
\end{equation}
where \(N=\sum_{i=1}^I n_i\). Similarly, \(\sigma_r^2\) is updated from
\begin{equation} \label{eq:sigmar2full}
\sigma_r^2\mid \cdot \sim \mathrm{IG}\Biggl(a_r+\frac{I}{2},\, b_r+\frac{1}{2}\bm{r}^\top Q(\rho)\bm{r}\Biggr).
\end{equation}
The spatial dependence parameter \(\rho\) does not have a closed-form full conditional and is updated via a Metropolis--Hastings step with a suitable proposal density. Finally, the flexible function \(f(\cdot)\) is updated using the Bayesian backfitting algorithm for SoftBART, wherein the sum-of-trees representation
\[
f(X_{ij},Z_{ij},\hat{e}(X_{ij})) = \sum_{h=1}^H g\Bigl(X_{ij},Z_{ij},\hat{e}(X_{ij});T_h,M_h\Bigr)
\]
is sequentially updated over the ensemble of \(H\) trees.

A single iteration of the Metropolis-within-Gibbs sampling algorithm is summarized in Algorithm~\ref{alg:msamp}.

\begin{algorithm}[H]
\caption{MCMC Sampling Algorithm for the Spatial AFTSBART Model}\label{alg:msamp}
\begin{enumerate}
    \item For each censored observation \((i,j)\), update \(y_{ij}^\ast\) according to (\ref{eq:latent}).
    \item Update the function \(f(\cdot)\) using the current latent outcomes \(\{y_{ij}^\ast\}\) and spatial effects \(\{r_i\}\) via Bayesian backfitting for SoftBART.
    \item For \(i=1,\ldots,I\), update the spatial random effect \(r_i\) from (\ref{eq:rfull}).
    \item Update \(\sigma^2\) from (\ref{eq:sigma2full}) and \(\sigma_r^2\) from (\ref{eq:sigmar2full}).
    \item Update \(\rho\) using a Metropolis--Hastings step.
\end{enumerate}
\end{algorithm}

Posterior samples from the above algorithm are used to estimate causal effects as contrasts in the predicted log survival times. The two-stage procedure—whereby the estimated propensity score \(\hat{e}(X_{ij})\) is included in the outcome model—achieves a form of double robustness analogous to frequentist methods, in that consistency may be maintained if either the treatment assignment or the outcome model is correctly specified.

\subsection{Posterior Inference for Causal Estimands}

Let \(\theta^{(s)} = \{f^{(s)}(\cdot), r^{(s)}, \sigma^{(s)}\}\) denote the \(s\)th posterior draw from the model. For an individual with covariates \(X\) and a cluster-specific spatial effect \(r\), the predictive distribution for \(\log T(z)\) under treatment \(z \in \{0,1\}\) is
\[
\log T(z) \mid X, r, \theta^{(s)} \sim N\Bigl(\mu_z^{(s)}, \bigl(\sigma^{(s)}\bigr)^2\Bigr),
\]
with
\[
\mu_z^{(s)} = f^{(s)}\Bigl(X, z, \hat{e}(X)\Bigr) + r^{(s)}.
\]

The corresponding survival function at time \(t\) is given by
\[
S^{(s)}(z)(t\mid X,r) = P\Bigl(T(z) \ge t \mid X,r,\theta^{(s)}\Bigr) = 1 - \Phi\Biggl(\frac{\log t - \mu_z^{(s)}}{\sigma^{(s)}}\Biggr),
\]
where \(\Phi(\cdot)\) denotes the standard normal cumulative distribution function.

\textbf{Conditional Survival Probability Causal Effect (CSPCE):}  
For a fixed time \(t\), the CSPCE for the \(s\)th draw is computed as
\[
\Delta \text{CSPCE}^{(s)}(t, X, r) = S^{(s)}(1)(t\mid X,r) - S^{(s)}(0)(t\mid X,r),
\]
or explicitly,
\[
\Delta \text{CSPCE}^{(s)}(t, X, r) = \Phi\Biggl(\frac{\log t - f^{(s)}\bigl(X,0,\hat{e}(X)\bigr) - r^{(s)}}{\sigma^{(s)}}\Biggr) - \Phi\Biggl(\frac{\log t - f^{(s)}\bigl(X,1,\hat{e}(X)\bigr) - r^{(s)}}{\sigma^{(s)}}\Biggr).
\]

\textbf{Conditional Average Causal Effect (CACE):}  
Exploiting the log-normality of \(T(z)\), the conditional expected survival time under treatment \(z\) is
\[
E\Bigl[T(z) \mid X,r,\theta^{(s)}\Bigr] = \exp\Bigl\{ f^{(s)}\bigl(X,z,\hat{e}(X)\bigr) + r^{(s)} + \frac{\bigl(\sigma^{(s)}\bigr)^2}{2} \Bigr\}.
\]
Thus, the \(s\)th posterior draw for the CACE is given by
\[
\Delta \text{CACE}^{(s)}(X, r) = \exp\Bigl\{ f^{(s)}\bigl(X,1,\hat{e}(X)\bigr) + r^{(s)} + \frac{\bigl(\sigma^{(s)}\bigr)^2}{2} \Bigr\} - \exp\Bigl\{ f^{(s)}\bigl(X,0,\hat{e}(X)\bigr) + r^{(s)} + \frac{\bigl(\sigma^{(s)}\bigr)^2}{2} \Bigr\}.
\]

\textbf{Conditional Restricted Average Causal Effect (CRACE):}  
The conditional restricted mean survival time under treatment \(z\) for a time horizon \(t^*\) is defined as
\[
E\Bigl[\min\bigl(T(z),t^*\bigr) \mid X,r,\theta^{(s)}\Bigr] = \int_{0}^{t^*} S^{(s)}(z)(t\mid X,r) \, dt.
\]
Therefore, the CRACE for the \(s\)th draw is
\[
\Delta \text{CRACE}^{(s)}(X, r) = \int_{0}^{t^*} \Bigl\{ S^{(s)}(1)(t\mid X,r) - S^{(s)}(0)(t\mid X,r) \Bigr\} dt.
\]
In practice, this integral can be approximated numerically (e.g., using Simpson's rule or Riemann sums).

Posterior inference on the estimands is then carried out by computing these quantities for each posterior draw \(s=1,\ldots,S\) and summarizing the resulting empirical distribution (e.g., via posterior means, credible intervals, etc.).
\end{document}

